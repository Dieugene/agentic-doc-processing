# Decision 003: Интеграция VLM-OCR модуля

**Статус:** Принято (обновлено)
**Дата:** 2025-01-23
**Контекст:** Tech Lead, вопросы по Итерации 2

---

## Контекст

У пользователя есть реализованный PoC VLM-OCR модуля для извлечения данных из документов. Модуль работает по extractive принципу: на вход — изображения страниц и промпт с вопросом "что извлечь".

В текущей архитектуре не определены:
1. Как интегрировать модуль в pipeline
2. Какой API между модулем и системой
3. Как оптимизировать множественные запросы (текст, структура, таблицы)

---

## Решение

**VLM-OCR как Python library с extractive API.**

### Принцип работы VLM-OCR

```
Вход:
  - PNG-изображения страниц (одна или несколько)
  - Extractive prompt: "что извлечь"

Выход:
  - Результат extraction согласно prompt
```

**Ключевая особенность:** Один вызов VLM-OCR может отвечать на несколько вопросов одновременно (batch prompts для оптимизации).

---

## Способ интеграции

### Library/Dependency

```
┌─────────────────────────────────────────────────────────┐
│                  DocumentProcessor                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  file_path (любой формат)                               │
│       │                                                  │
│       ▼                                                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Converter                                 │   │
│  │  DOCX/Excel/text-PDF → PDF                        │   │
│  └──────────────────────────────────────────────────┘   │
│       │                                                  │
│       ▼                                                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Renderer                                  │   │
│  │  PDF → PNG (постранично)                          │   │
│  └──────────────────────────────────────────────────┘   │
│       │                                                  │
│       ▼                                                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │         VLM-OCR Library                           │   │
│  │                                                   │   │
│  │  extract(images, prompts):                       │   │
│  │    - текст                                       │   │
│  │    - структура (заголовки)                        │   │
│  │    - таблицы + классификация                      │   │
│  │    - описания схем/изображений                    │   │
│  └──────────────────────────────────────────────────┘   │
│       │                                                  │
│       ▼                                                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Skeleton Builder                          │   │
│  │  → DocumentSkeleton                               │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## VLM-OCR API (контракт)

### Вход

```python
class VLMOCRRequest:
    images: List[Union[str, bytes]]    # PNG-изображения страниц
    prompts: List[str]                  # extractive prompts

    # Примеры prompts:
    # - "Верни весь текст с этих страниц"
    # - "Опиши структуру документа: заголовки, иерархию"
    # - "Найди все таблицы, классифицируй (числовые/текстовые)"
    # - "Опиши все схемы и изображения на этих страницах"
```

### Выход

```python
class VLMOCRResponse:
    success: bool
    results: List[ExtractionResult]

class ExtractionResult:
    prompt: str                  # какой prompt был
    data: Dict[str, Any]         # результат extraction

    # Для текста:
    # { "text": "полный текст...", "pages": {...} }

    # Для структуры:
    # { "structure": [...], "headers": [...] }

    # Для таблиц:
    # { "tables": [
    #     { "id": "table_1", "type": "NUMERIC" | "TEXT_MATRIX",
    #       "location": {...}, "preview": "..." }
    #   ]}
```

---

## Оптимизация запросов

### Проблема

VLM-OCR работает со скользящим окном (не все страницы одномоментно). Нужно оптимизировать множественные запросы.

### Решение: Batch prompts

```python
# Один вызов VLM-OCR с несколькими prompts
vlm_ocr.extract(
    images=[page1, page2, page3],
    prompts=[
        "Верни текст",
        "Опиши структуру",
        "Найди и классифицируй таблицы"
    ]
)

# → один VLM-вызов, три результата
```

### Скользящее окно

```python
# Для больших документов
for page_window in sliding_windows(document, window_size=10):
    results = vlm_ocr.extract(
        images=page_window,
        prompts=[...]  # batch prompts
    )
    aggregate(results)
```

---

## Обработка таблиц (специфика)

VLM-OCR классифицирует таблицы, но не извлекает числовые данные.

### Workflow

```
1. VLM-OCR находит таблицы → классифицирует:
   - Тип А (NUMERIC): числовые данные
   - Тип Б (TEXT_MATRIX): текстовая матрица

2. Для Тип А:
   - Table Extractor извлекает из исходного файла
   - Pandas DataFrame
   - Используется для computations

3. Для Тип Б:
   - VLM-OCR делает Cell Flattening
   - → список утверждений
```

### VLM-OCR prompt для таблиц

```
"Найди все таблицы на этих страницах.
Для каждой таблицы определи:
- Тип: NUMERIC (числа) или TEXT_MATRIX (текст)
- Расположение (номер страницы, область)
- Краткое описание содержимого

Для TEXT_MATRIX таблиц:
- Выполни Cell Flattening (заголовок строки + заголовок столбца → содержимое)"
```

---

## Интеграция в коде

```python
# 02_src/processing/vlm_ocr_extractor.py

class VLMOCRExtractor:
    """Обёртка над VLM-OCR модулем"""

    def __init__(self, vlm_ocr_module):
        self.vlm = vlm_ocr_module

    def extract_full_document(self, images: List[bytes]) -> DocumentData:
        """Извлекает всё: текст, структуру, таблицы"""

        # Batch prompts для оптимизации
        results = self.vlm.extract(
            images=images,
            prompts=[
                "Верни весь текст с этих страниц",
                "Опиши иерархическую структуру: заголовки и их уровни",
                "Найди все таблицы, классифицируй (NUMERIC/TEXT_MATRIX)"
            ]
        )

        return DocumentData(
            text=results[0].data,
            structure=results[1].data,
            tables=results[2].data
        )
```

---

## Обоснование

1. **Extractive approach:** VLM-OCR извлекает именно то что нужно (не всё подряд)

2. **Единый модуль:** Работает для всех форматов через PDF→PNG

3. **Безопасность:** Текст идет через картинку → mitigation промпт-инъекций

4. **Оптимизация:** Batch prompts уменьшают количество VLM-вызовов

5. **Гибкость:** VLM-OCR может возвращать всё: текст, структуру, описания схем

---

## Последствия

### Для реализации

- **VLM-OCR module** — основная зависимость (существующий PoC)
- **Converter** — нужен для DOCX/Excel → PDF
- **Renderer** — уже есть в VLM-OCR модуле
- **Skeleton Builder** — агрегирует результаты VLM-OCR

### Для архитектуры

- DocumentProcessor → VLM-OCR (library) → DocumentSkeleton
- Числовые таблицы: гибридный путь (через Table Extractor из исходника)
- VLM-OCR должен поддерживать batch prompts

### Ограничения

- VLM-OCR работает постранично (скользящее окно для больших документов)
- Нужно кэшировать результаты (не перерабатывать одни и те же страницы)

---

## Связанные решения

- **ADR-001:** Форматы документов (все через VLM-OCR, таблицы гибрид)
- **SP-001:** Spike для тестирования VLM-OCR модуля (если требуется)
