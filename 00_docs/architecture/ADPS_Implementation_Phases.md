# Agentic Document Processing System
## Этапы реализации

**Версия:** 0.1
**Дата:** 2026-02-11

**Связанные документы:**
- [Обзор архитектуры](overview.md)
- [Уровень 3: Сквозные сценарии](ADPS_Architecture_L3.md)

---

## 1. Принципы разбиения на этапы

### 1.1. Критерии

| Критерий | Описание |
|----------|----------|
| **Гомогенность** | Компоненты внутри этапа связаны по смыслу и технологии |
| **Целостность** | Этап имеет чёткий вход и выход, даёт измеримую ценность |
| **Минимальные связи** | Границы между этапами проходят по естественным стыкам |
| **Итеративность** | Каждый этап добавляет функциональность, не требуя переделки предыдущих |

### 1.2. Ограничения

- **Не создавать временные решения**, которые будут выброшены
- **Агент Q реализуется один раз** — в полном виде (с матрицей, топик-агентами)
- **Каждый этап даёт ценность** пользователю или разработчику

---

## 2. Этапы реализации

```
┌─────────────────────────────────────────────────────────────────┐
│ Этап 1: Препроцессинг                                      │
│ ZIP → документ-юниты (пустые)                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Этап 2: Структура                                          │
│ документ-юнит (пустой) → документ-юнит с DAG, оглавлением │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Этап 3: Тематическая обработка                              │
│ документ-юнит со структурой → документ-юнит с матрицей,   │
│ выписками                                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Этап 4: Ответы на вопросы                                   │
│ документ-юнит с матрицей, query → ответ                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Этап 1: Препроцессинг

### 3.1. Описание

Техническая подготовка документов к обработке: распаковка архивов, конвертация файлов, группировка в документ-юниты.

### 3.2. Вход / Выход

| Аспект | Значение |
|---------|----------|
| **Вход** | ZIP-архив с файлами |
| **Выход** | Набор документ-юнитов (без структуры) |
| **Артефакты** | Реестр документов, маппинг файлы → документы |

### 3.3. Компоненты для реализации

| Компонент | Ответственность | Зависимости |
|-----------|-----------------|-------------|
| Координатор (базовый) | Создаёт документ-юниты, передаёт их Препроцессору | — |
| Препроцессор | Оркестрация модулей | Координатор |
| Распаковщик | Извлечение файлов из ZIP | — |
| Конвертер | DOCX → PDF через внешние сервисы | Периферия.Конвертация |
| Группировщик | Определение принадлежности файлов к документам | VLM-клиент |
| Документ-юнит (пустой) | Контейнер для PDF-файлов | — |
| Сервисы конвертации | GroupDocs / ConvertAPI | Внешние API |

### 3.4. Периферия

- Сервисы конвертации (GroupDocs, ConvertAPI)
- VLM-клиент (для группировки)

### 3.5. Ценность

- Пользователь видит, какие документы выделены из архива
- Все файлы приведены к единому формату (PDF)
- Базовая для следующих этапов

### 3.6. Тестовый сценарий

```
Вход: архив с 3 документами (разные типы)
Проверка:
- Создано 3 документ-юнита
- Все файлы сконвертированы в PDF
- Реестр документов корректен
```

---

## 4. Этап 2: Структура

### 4.1. Описание

Извлечение структуры документа: построение DAG блоков и оглавления.

### 4.2. Вход / Выход

| Аспект | Значение |
|---------|----------|
| **Вход** | Документ-юнит с PDF-файлами |
| **Выход** | Документ-юнит с DAG, оглавлением |
| **Артефакты** | DocumentStructure, Block (см. L4) |

### 4.3. Компоненты для реализации

| Компонент | Ответственность | Зависимости |
|-----------|-----------------|-------------|
| Агент X (структурный экстрактор) | Управляет извлечением через vlm-ocr-doc-reader | vlm-ocr-doc-reader |
| vlm-ocr-doc-reader | Извлекает контент страниц | Внешний модуль |
| Хранилище (структуры) | Сохраняет DAG, оглавление | — |
| Навигационный слой (базовый) | Оглавление, поиск по блокам | — |

### 4.4. Периферия

- vlm-ocr-doc-reader

### 4.5. Ценность

- Пользователь видит структуру документа (оглавление)
- Возможна навигация по блокам
- Базовая для тематики (нужно знать блоки)

### 4.6. Тестовый сценарий

```
Вход: документ-юнит с PDF (50 страниц)
Проверка:
- DAG построен (20 блоков)
- Оглавление соответствует разделам
- Структура сохранена в хранилище
```

---

## 5. Этап 3: Тематическая обработка

### 5.1. Описание

Разбор документа по темам: построение навигационной матрицы, создание выписок.

**Важно:** На этом этапе Агент Q ещё не реализован. Тематический разбор инициируется:
- Через Топик-провайдер (если подключен)
- Через API запрос (набор тем для разбора)

### 5.2. Вход / Выход

| Аспект | Значение |
|---------|----------|
| **Вход** | Документ-юнит со структурой, набор тем |
| **Выход** | Документ-юнит с навигационной матрицей, выписками |
| **Артефакты** | Topic, NavigationMatrix, Extract, MatrixCell |

### 5.3. Компоненты для реализации

| Компонент | Ответственность | Зависимости |
|-----------|-----------------|-------------|
| Топик-провайдер | Поставляет темы для разбора (опционально) | — |
| Тематический анализатор | Управляет разбором, создаёт топик-агентов | — |
| Топик-агент | Разбор одной темы, создаёт блок-агентов | Блок-агенты |
| Блок-агент | Извлечение данных по теме из блока | vlm-ocr-doc-reader |
| Навигационный слой (полный) | Матрица, поиск, выписки | — |
| Хранилище (тема/матрица) | Сохранение матрицы, выписок | — |
| LLM-клиент | Обращение к LLM | Внешние API |

### 5.4. Периферия

- LLM-провайдеры (Anthropic, OpenAI, и т.д.)

### 5.5. Инициирование разбора

**Способ A: Через Топик-провайдер**
```
Координатор → Документ-юнит:
    process(files, doc_type, topic_provider, callback)

Документ-юнит → Топик-провайдер: get_topics(тип)
Топик-провайдер → Т1
Документ-юнит → Тематический анализатор: разобрать Т1
```

**Способ B: Через API запрос**
```
POST /api/documents/{doc_id}/topics
Body: { "topics": ["риски", "обязательства", "..."] }

Документ-юнит → Тематический анализатор: разобрать темы
```

### 5.6. Ценность

- Пользователь видит, какие темы отражены в документе
- Навигационная матрица позволяет найти нужный блок по теме
- Выписки дают суммаризированную информацию по теме

### 5.7. Тестовый сценарий

```
Вход: документ-юнит со структурой, темы = ["риски", "сроки"]
Проверка:
- Создана навигационная матрица (2 столбца × 20 блоков)
- Каждая ячейка заполнена (описание или "не отражено")
- Созданы 2 выписки
- Выписки сохранены в хранилище
```

---

## 6. Этап 4: Ответы на вопросы

### 6.1. Описание

Реализация Агента Q для обработки пользовательских запросов с использованием навигационной матрицы и выписок.

### 6.2. Вход / Выход

| Аспект | Значение |
|---------|----------|
| **Вход** | Документ-юнит с матрицей, query |
| **Выход** | Ответ на вопрос |
| **Артефакты** | История диалога Агента Q |

### 6.3. Компоненты для реализации

| Компонент | Ответственность | Зависимости |
|-----------|-----------------|-------------|
| Агент Q | Определение Т_целевых, сбор ответа, синтез | Топик-агенты, Тематический анализатор |
| История Агента Q | Сохранение контекста между запросами | Хранилище |

### 6.4. Логика работы

**Сценарий A: Первичный запрос**
```
1. Агент Q получает query и Т1 (или Т_разобранные)
2. Определяет Т_целевые = релевантные темы для ответа
3. Инициирует разбор Т_целевых (если не разобраны)
4. Опрашивает топик-агентов по Т_целевым
5. Синтезирует ответ на основе выписок
```

**Сценарий B: Повторный запрос**
```
1. Агент Q получает query и Т_разобранные
2. Определяет Т_готовые = нужные ∩ Т_разобранные
3. Определяет Т_доразобрать = нужные \ Т_разобранные
4. Инициирует разбор Т_доразобрать (если нужно)
5. Опрашивает топик-агентов
6. Синтезирует ответ с учётом истории
```

### 6.5. Ценность

- Пользователь получает ответы на вопросы
- Ответы основаны на заранее разобранных темах (быстро)
- История диалога позволяет уточнять вопросы

### 6.6. Тестовый сценарий

```
Вход: документ-юнит с матрицей (5 тем), query = "Какие риски связаны с задержкой?"
Проверка:
- Агент Q определил Т_целевые = ["риски", "сроки"]
- Если темы не разобраны — инициирован разбор
- Топик-агенты опрошены
- Ответ синтезирован на основе выписок
- История сохранена
```

---

## 7. Границы этапов

### 7.1. Между Этапом 1 и Этапом 2

**Интерфейс:**
```
Документ-юнит
  - files: List<PDF>
  - doc_type: string
```

**Критерий завершения Этапа 1:**
- Документ-юниты созданы
- Файлы сконвертированы в PDF
- Реестр документов доступен

---

### 7.2. Между Этапом 2 и Этапом 3

**Интерфейс:**
```
Документ-юнит
  - files: List<PDF>
  - structure: DocumentStructure
    - blocks: List<Block>
    - toc: TOC
```

**Критерий завершения Этапа 2:**
- DAG блоков построен
- Оглавление доступно
- Структура сохранена в хранилище

---

### 7.3. Между Этапом 3 и Этапом 4

**Интерфейс:**
```
Документ-юнит
  - structure: DocumentStructure
  - navigation_matrix: NavigationMatrix
  - extracts: Map<Topic, Extract>
  - analyzed_topics: Set<Topic>
```

**Критерий завершения Этапа 3:**
- Навигационная матрица построена (минимум 1 тема)
- Выписки созданы
- Тематический разбор инициируется корректно

---

## 8. Параллельная работа

### 8.1. Внутри Этапа 3

**Параллельно:**
- Разбор разных тем (топик-агенты)
- Разбор разных блоков (блок-агенты)

**Последовательно:**
- Темы (для заполнения столбцов матрицы)
- Подблоки (иерархия)

### 8.2. Между этапами

| Этап | Может параллелиться с |
|-------|---------------------|
| 1 | — (базовый) |
| 2 | Другие документ-юниты на этапе 2 |
| 3 | Другие документ-юниты на этапе 3 |
| 4 | — (зависит от 3) |

---

## 9. Порядок реализации

### 9.1. Минимальный порядок

```
Этап 1 → Этап 2 → Этап 3 → Этап 4
```

### 9.2. Возможные вариации

| Вариация | Описание | Когда применимо |
|----------|----------|----------------|
| 1+2 вместе | Препроцессинг + структура сразу | Если vlm-ocr-doc-reader уже интегрирован |
| 3 частичный | Разбор 1-2 тем для теста | Для проверки агентской модели |
| 3 без Топик-провайдера | Темы формируются вручную | Если Топик-провайдер не готов |

---

## 10. Открытые вопросы

| # | Вопрос | Контекст | Приоритет |
|---|--------|----------|-----------|
| 1 | Инициирование разбора на Этапе 3 | API формат, авторизация | High |
| 2 | Топик-провайдер на Этапе 3 | Реализовывать или отложить? | Medium |
| 3 | Формат выписки | Детализация структуры, ограничения | Medium |
| 4 | История Агента Q на Этапе 4 | Полная, без истории, заметки? | Low |

---

## 11. История изменений

| Дата | Версия | Изменение |
|------|--------|-----------|
| 2026-02-11 | 0.1 | Создан документ с описанием 4 этапов реализации |
