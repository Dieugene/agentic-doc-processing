# Agentic Document Processing System
## Архитектурная модель. Уровень 2: Компоненты и границы

**Версия:** 0.2  
**Дата:** 2026-01-29

**Связанные документы:**
- Концептуальная модель (ADPS_Conceptual_Model.md)
- Архитектурная модель. Уровень 1 (ADPS_Architecture_L1.md)

---

## 1. Введение

### 1.1. Назначение документа

Документ описывает компонентную структуру системы ADPS, определяет границу между ядром и периферией, фиксирует MVP и принципы оркестрации.

Документ предполагает знакомство читателя с:
- Концептуальной моделью ADPS (понятия: документ, файл, блок, тема, узел, выписка, контент-агент)
- Архитектурной моделью уровня 1 (пайплайн обработки из 7 этапов, артефакты, связь с vlm-ocr-doc-reader)

### 1.2. Краткое напоминание о пайплайне

Система обрабатывает документы по следующему пайплайну:

1. **Приём** — получение архивов, опционально вопроса
2. **Нормализация** — приведение файлов к PDF
3. **Группировка** — определение, какие файлы относятся к каким документам
4. **Извлечение контента** — обработка через vlm-ocr-doc-reader
5. **Построение структуры** — DAG блоков, оглавление
6. **Тематический разбор** — выделение тем, навигационная матрица, выписки
7. **Обработка запросов** — формирование ответов контент-агентами

---

## 2. MVP

### 2.1. Определение

**Минимально жизнеспособный продукт** — система, способная:
- Принять на вход архив с документами и вопрос к ним
- Выполнить полную обработку по всем этапам пайплайна
- Вернуть ответ на вопрос

### 2.2. Обоснование

Рассматривались варианты упрощения пайплайна для ускорения первой реализации. Однако анализ показал, что даже для «простых» вопросов может потребоваться полная индексация и тематический разбор: прямого ответа в документе может не быть, и для его формирования необходимо глубокое понимание структуры и содержания.

Поэтому MVP включает все этапы пайплайна без сокращений.

### 2.3. Приоритеты реализации

1. **Первый этап (ближайший месяц):** работа с потоком документов — автоматизированная обработка документов, поступающих из внешних источников, с извлечением данных по запросу
2. **Второй этап (через месяц):** работа с большими регламентами — итеративный многослойный анализ для извлечения процессов и построения диаграмм

---

## 3. Оркестрация

### 3.1. Наблюдение

Два основных сценария использования отличаются не глубиной обработки документа, а способом управления этой обработкой:

| Сценарий | Паттерн взаимодействия | Кто управляет |
|----------|------------------------|---------------|
| Поток документов | Один запрос → полная обработка → ответ | Внутренний координатор системы |
| Анализ регламента | Множество итеративных запросов, каждый может породить новый тематический разбор | Внешний оркестратор (собственный или Claude через MCP) |

### 3.2. Архитектурное решение

**Оркестрация — часть периферии, не ядра.**

Ядро предоставляет операции для выполнения этапов пайплайна. Кто, когда и в какой последовательности вызывает эти операции — определяется оркестратором, который может быть разным в зависимости от контекста использования.

---

## 4. Компоненты системы

### 4.1. Обзор

Система состоит из следующих компонентов:

```
┌─────────────────────────────────────────────────────────────┐
│                        ПЕРИФЕРИЯ                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Источники   │  │ Сервисы     │  │ Хранилище состояния │  │
│  │ документов  │  │ конвертации │  │ (файлы / БД)        │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                    │             │
│  ┌──────┴────────────────┴────────────────────┴──────────┐  │
│  │                         ЯДРО                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │  │
│  │  │Препроцессор │→ │ Координатор │→ │   Документ    │  │  │
│  │  │(группировка)│  │  обработки  │  │ (N файлов)    │  │  │
│  │  └─────────────┘  └─────────────┘  └───────────────┘  │  │
│  │                          ↑                            │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │            Фабрика агентов                      │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                   │
│  ┌──────┴──────────────────────────────────────────────┐    │
│  │ LLM-провайдеры │ Шаблоны тем │ Внешний оркестратор  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 4.2. Препроцессор

**Ответственность:**
- Приём входных данных (архивов)
- Распаковка
- Нормализация форматов (DOCX → PDF)
- Группировка файлов по документам

**Этапы пайплайна:** 1 (Приём), 2 (Нормализация), 3 (Группировка)

**Детали реализации:**

Группировка файлов по документам выполняется путём анализа начальных страниц (титульные листы, заголовки) с участием LLM. Результат — реестр документов и маппинг «документ → список файлов».

**Архитектурный статус:**

Препроцессор — не монолитный компонент. Внутри него:
- *Ядро:* логика группировки файлов по документам
- *Периферия:* адаптеры источников (файловая система, URL, API), адаптеры конвертации (GroupDocs, ConvertAPI)

**Выходные артефакты:**
- Реестр документов
- Маппинг: документ → список PDF-файлов

### 4.3. Координатор обработки

**Ответственность:**
- Получение реестра документов от препроцессора
- Запуск обработки по каждому документу
- Передача вопросов в документы
- Сбор и агрегация результатов

**Архитектурный статус:** ядро.

**Взаимодействие с внешним миром:**

В сценарии MCP-сервера внешний оркестратор (например, Claude) взаимодействует именно с координатором: передаёт вопросы, получает ответы, инициирует дополнительные тематические разборы.

**Примечание:** координатор не определяет *стратегию* обработки (какие вопросы задавать, в каком порядке). Он *исполняет* команды, поступающие извне или из конфигурации.

### 4.4. Документ

**Ответственность:**
- Агрегация экземпляров vlm-ocr-doc-reader (по одному на каждый файл документа)
- Извлечение контента из файлов
- Построение структуры (DAG блоков, оглавление)
- Хранение всех артефактов документа
- Навигация по контенту
- Тематический анализ

**Этапы пайплайна:** 4 (Извлечение), 5 (Структура), 6 (Тематический разбор), 7 (Обработка запросов)

**Архитектурный статус:** ядро.

**Внутренняя структура:**

Компонент «Документ» включает:

**Навигационный слой** — обеспечивает поиск контента:
- Оглавление (структура с привязкой к страницам)
- Навигационная матрица (соответствие блоков и тем)
- Линкер (переходы между блоками/узлами)

**Тематический анализатор** — выполняет тематический разбор:
- Построение навигационной матрицы по заданным темам
- Формирование выписок
- Использует контент-агентов в режиме extract

**Хранимые артефакты:**
- DAG блоков документа
- Оглавление
- Список тем
- Навигационная матрица
- Выписки
- История запросов и ответов

### 4.5. Определитель тем

**Ответственность:** определение набора тем для тематического разбора документа.

**Режимы работы:**

| Режим | Описание | Когда используется |
|-------|----------|-------------------|
| По шаблону | Набор тем определяется типом документа | Для типовых документов с накопленным опытом |
| По вопросу | Тема извлекается из входящего вопроса | При обработке конкретного запроса |
| Автоматически | LLM анализирует документ и предлагает темы | Для тестирования, исследования нового документа |

**Архитектурный статус:** интерфейс ядра с периферийными реализациями.

**Важно:** определитель тем может отсутствовать. Если нет шаблонов, нет входящего вопроса и не подключён автоопределитель — документ обрабатывается только до этапа построения структуры и ожидает поступления вопросов.

### 4.6. Фабрика агентов (контент-агенты)

**Ответственность:** предоставление механизма работы с контентом через LLM.

**Режимы работы агентов:**

| Режим | Назначение | Где используется |
|-------|-----------|------------------|
| Extract | Извлечение информации из исходного документа | Тематический анализатор (этап 6) |
| Infer | Формирование ответов на основе извлечённой информации | Обработка запросов (этап 7) |

**Архитектурный статус:** переиспользуемый механизм ядра.

**Модель существования агента:**

Контент-агент — не обязательно постоянно существующий объект в памяти. Агент представляет собой **хранимое состояние**:
- Системный промпт (инструкции агенту)
- Набор подключённых инструментов с описаниями
- История сообщений

При необходимости выполнить работу:
1. Состояние загружается
2. Агент активируется
3. Агент выполняет задачу (взаимодействует с LLM, вызывает инструменты)
4. Состояние сохраняется
5. Агент «растворяется»

Такая модель позволяет:
- Экономить ресурсы (агент существует только во время работы)
- Сохранять контекст между сессиями
- Масштабировать количество агентов без ограничений памяти

**Зависимости:**
- *Ядро:* логика работы агента (циклы вызовов, обработка инструментов, управление состоянием)
- *Периферия:* LLM-провайдеры (Claude, GPT, локальные модели)

---

## 5. Граница ядро / периферия

### 5.1. Принцип

Граница между ядром и периферией проходит **внутри компонентов**, а не между ними.

Компонент может содержать ядровую логику и использовать периферийные адаптеры. Это позволяет:
- Менять реализацию периферии без изменения ядра
- Тестировать ядро изолированно
- Адаптировать систему к разным контекстам использования

### 5.2. Состав ядра

| Элемент | Описание |
|---------|----------|
| Координатор обработки | Управление пайплайном, маршрутизация запросов |
| Документ | Агрегация файлов, хранение артефактов, навигация, тематический анализ |
| Логика группировки | Алгоритм определения принадлежности файлов к документам |
| Логика работы агентов | Циклы вызовов LLM, обработка инструментов, управление состоянием |
| Интерфейс определителя тем | Контракт для получения набора тем |

### 5.3. Состав периферии

| Элемент | Варианты реализации |
|---------|---------------------|
| Источники документов | Файловая система, URL, API |
| Сервисы конвертации | GroupDocs, ConvertAPI |
| Хранилище состояния | Файлы (JSON для метаданных, YAML для контента) или БД |
| Реализации определителя тем | По шаблону, автоматически (LLM) |
| LLM-провайдеры | Claude Haiku, GPT-5-mini, локальные модели |
| Оркестратор | CLI-скрипт, MCP-клиент (Claude), собственный сервис |

---

## 6. Диаграммы

### 6.1. Компоненты и потоки данных

```mermaid
flowchart TB
    subgraph input["Вход"]
        ARCHIVES[Архивы]
        QUESTION[Вопрос]
    end

    subgraph periphery_in["Периферия: источники"]
        SRC_FS[Файловая система]
        SRC_URL[URL]
        SRC_API[API]
    end

    subgraph periphery_conv["Периферия: конвертация"]
        GROUPDOCS[GroupDocs]
        CONVERTAPI[ConvertAPI]
    end

    subgraph core["Ядро"]
        subgraph preproc["Препроцессор"]
            UNPACK[Распаковка]
            NORM[Нормализация]
            GROUP[Группировка файлов]
        end

        COORD[Координатор обработки]

        subgraph doc["Документ"]
            VLM["vlm-ocr-doc-reader<br/>(×N файлов)"]
            STRUCT[Структура<br/>DAG, оглавление]
            NAV[Навигационный слой]
            THEMATIC[Тематический анализатор]
            ARTIFACTS[(Артефакты)]
        end

        AGENTS[Фабрика агентов]
        TOPIC_IF{{Интерфейс<br/>определителя тем}}
    end

    subgraph periphery_out["Периферия: сервисы"]
        STORAGE[(Хранилище)]
        TEMPLATES[(Шаблоны тем)]
        LLM[LLM-провайдеры]
    end

    subgraph output["Выход"]
        ANSWER[Ответ]
    end

    ARCHIVES --> SRC_FS
    ARCHIVES --> SRC_URL
    SRC_FS --> UNPACK
    SRC_URL --> UNPACK
    SRC_API --> UNPACK
    UNPACK --> NORM
    NORM --> GROUPDOCS
    NORM --> CONVERTAPI
    GROUPDOCS --> GROUP
    CONVERTAPI --> GROUP
    GROUP --> COORD
    QUESTION --> COORD
    COORD --> VLM
    VLM --> STRUCT
    STRUCT --> NAV
    COORD --> TOPIC_IF
    TOPIC_IF --> TEMPLATES
    NAV --> THEMATIC
    THEMATIC --> AGENTS
    AGENTS --> LLM
    THEMATIC --> ARTIFACTS
    ARTIFACTS --> STORAGE
    COORD --> ANSWER
```

### 6.2. Внутренняя структура компонента «Документ»

```mermaid
flowchart TB
    subgraph doc["Документ"]
        subgraph readers["vlm-ocr-doc-reader"]
            R1[Reader: файл 1]
            R2[Reader: файл 2]
            RN[Reader: файл N]
        end

        subgraph structure["Структура"]
            DAG[DAG блоков]
            TOC[Оглавление]
        end

        subgraph navigation["Навигационный слой"]
            MATRIX[Навигационная матрица]
            LINKER[Линкер]
        end

        subgraph analysis["Тематический анализатор"]
            EXTRACT[Extract-операции]
            BUILD[Построение матрицы]
            SUMMARIES[Формирование выписок]
        end

        subgraph artifacts["Артефакты"]
            TOPICS_LIST[Список тем]
            EXTRACTS_STORE[Выписки]
            HISTORY[История запросов]
        end
    end

    R1 --> DAG
    R2 --> DAG
    RN --> DAG
    DAG --> TOC
    TOC --> MATRIX
    EXTRACT --> BUILD
    BUILD --> MATRIX
    BUILD --> SUMMARIES
    SUMMARIES --> EXTRACTS_STORE
```

### 6.3. Жизненный цикл контент-агента

```mermaid
flowchart LR
    subgraph storage["Хранилище"]
        STATE[(Состояние агента)]
    end

    subgraph lifecycle["Жизненный цикл"]
        LOAD[Загрузка состояния]
        ACTIVATE[Активация]
        WORK[Выполнение задачи]
        SAVE[Сохранение состояния]
        DISPOSE[Освобождение]
    end

    subgraph runtime["Взаимодействие"]
        LLM[LLM-провайдер]
        TOOLS[Инструменты]
    end

    STATE --> LOAD
    LOAD --> ACTIVATE
    ACTIVATE --> WORK
    WORK <--> LLM
    WORK <--> TOOLS
    WORK --> SAVE
    SAVE --> STATE
    SAVE --> DISPOSE
```

### 6.4. Сценарии оркестрации

```mermaid
flowchart TB
    subgraph scenario1["Сценарий: Поток документов"]
        EXT1[Внешний сервис]
        COORD1[Координатор]
        DOC1[Документ]
        
        EXT1 -->|архив + вопрос| COORD1
        COORD1 -->|обработка| DOC1
        DOC1 -->|ответ| COORD1
        COORD1 -->|результат| EXT1
    end

    subgraph scenario2["Сценарий: MCP (регламент)"]
        CLAUDE[Claude]
        MCP[MCP-интерфейс]
        COORD2[Координатор]
        DOC2[Документ]
        
        CLAUDE -->|вопрос 1| MCP
        MCP --> COORD2
        COORD2 --> DOC2
        DOC2 --> COORD2
        COORD2 --> MCP
        MCP -->|ответ 1| CLAUDE
        CLAUDE -->|вопрос 2| MCP
        MCP --> COORD2
    end
```

---

## 7. Открытые вопросы

| # | Вопрос | Контекст |
|---|--------|----------|
| 1 | Название компонента «Документ» | Совпадает с концептуальным понятием, возможна путаница. Альтернативы: DocumentProcessor, DocumentContext, DocumentUnit |
| 2 | Где живёт логика определения тем | В координаторе (он решает, нужен ли тематический разбор) или в документе (он знает свой тип и может запросить шаблон)? |
| 3 | Структура состояния агента | Требует детализации: формат хранения, управление историей, ограничения на размер |
| 4 | Обработка XLSX | Отложено. Требует отдельной проработки механики работы с электронными таблицами |
| 5 | Навигация между документами | Если запрос требует данных из нескольких документов — кто это координирует? Координатор или отдельный механизм? |
