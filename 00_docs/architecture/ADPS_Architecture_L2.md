# Agentic Document Processing System
## Архитектурная модель. Уровень 2

**Версия:** 0.1  
**Дата:** 2026-01-29

---

## 1. MVP

**Формулировка:** архив + вопрос → полная обработка по пайплайну → ответ

Упрощений пайплайна для MVP не предусмотрено. Даже если вопрос выглядит простым, для ответа может потребоваться полная индексация, навигация и тематический разбор.

---

## 2. Оркестрация и контексты использования

Разница между контекстами использования — не в глубине обработки, а в **оркестрации**:

| Контекст | Паттерн | Оркестратор |
|----------|---------|-------------|
| Поток документов | один запрос → полная обработка → ответ | встроенный |
| Регламент | много запросов итеративно, каждый может породить тематический разбор | внешний (свой или Claude через MCP) |

**Вывод:** оркестрация — часть периферии, не ядра. Ядро выполняет этапы, а кто и как их координирует — зависит от контекста.

---

## 3. Компоненты системы

### 3.1. Препроцессор

**Ответственность:** приём, нормализация, группировка файлов по документам.

**Состав:**
- Адаптеры источников (файловая система, URL, API) — *периферия*
- Адаптеры конвертации (GroupDocs, ConvertAPI) — *периферия*
- Логика группировки файлов по документам (анализ начальных страниц с LLM) — *ядро*

**Выход:** реестр документов, маппинг документ → файлы.

### 3.2. Координатор обработки

**Ответственность:** запуск пайплайна по каждому документу, передача вопросов, сбор результатов.

**Относится к:** ядро.

**Примечание:** в MCP-сценарии внешний оркестратор (Claude) взаимодействует с координатором — передаёт вопросы, получает результаты.

### 3.3. Документ

**Ответственность:** 
- Агрегирует экземпляры vlm-ocr-doc-reader (по одному на файл)
- Хранит артефакты (DAG, оглавление, темы, матрица, выписки, история)
- Извлечение контента
- Построение структуры

**Относится к:** ядро.

**Включает:**
- **Навигационный слой** — оглавление, навигационная матрица, линкер. Работает с артефактами конкретного документа.
- **Тематический анализатор** — строит матрицу, формирует выписки по заданным темам.

### 3.4. Определитель тем

**Ответственность:** выделяет набор тем для тематического разбора.

**Режимы:**
- По шаблону (зависит от типа документа)
- По входящему вопросу
- Автоматически (LLM анализирует документ)

**Архитектурный статус:** интерфейс ядра с периферийными реализациями.

**Может отсутствовать.** Если нет шаблонов, нет вопросов и не подключён автоопределитель — документ прорабатывается по структуре и ожидает вопросов.

### 3.5. Контент-агенты (фабрика агентов)

**Ответственность:** инфраструктурный механизм для работы с контентом.

**Режимы работы:**
- **Extract** — извлечение информации из документа (используется тематическим анализатором)
- **Infer** — изложение, формирование ответов (используется при обработке запросов)

**Архитектурный статус:** переиспользуемый механизм, не привязан к конкретному этапу пайплайна.

**Модель существования агента:**
Агент — не обязательно постоянный экземпляр в памяти. Это хранимое состояние:
- Системный промпт
- Подключённые инструменты с описанием
- История сообщений

При необходимости на основе состояния агент активируется, отрабатывает, сохраняет состояние и «растворяется».

**Зависимости:**
- LLM-провайдеры — *периферия*
- Логика работы агента (циклы, инструменты, состояние) — *ядро*

---

## 4. Граница ядро / периферия

Граница проходит **внутри компонентов**, а не между ними.

### 4.1. Ядро

| Компонент/логика | Описание |
|------------------|----------|
| Координатор обработки | Управление пайплайном по документам |
| Документ | Агрегация, хранение артефактов, структура, навигация, тематический анализ |
| Логика группировки файлов | Часть препроцессора: анализ и группировка |
| Логика работы агентов | Фабрика агентов: циклы, инструменты, состояние |
| Интерфейс определителя тем | Контракт для получения тем |

### 4.2. Периферия (адаптеры)

| Адаптер | Описание |
|---------|----------|
| Источники документов | Файловая система, URL, API |
| Сервисы конвертации | GroupDocs, ConvertAPI |
| Хранилище состояния | Файлы (JSON/YAML) или БД |
| Хранилище шаблонов тем | Реализации определителя тем |
| LLM-провайдеры | Claude, GPT, локальные модели |

---

## 5. Диаграммы

### 5.1. Компоненты и их отношения

```mermaid
flowchart TB
    subgraph periphery_in["Периферия: вход"]
        SRC[Источники документов]
        CONV[Сервисы конвертации]
    end

    subgraph core["Ядро"]
        subgraph preproc["Препроцессор"]
            GROUPING[Логика группировки]
        end
        
        COORD[Координатор обработки]
        
        subgraph doc["Документ"]
            VLM[vlm-ocr-doc-reader ×N]
            ARTIFACTS[Артефакты]
            NAV[Навигационный слой]
            THEMATIC[Тематический анализатор]
        end
        
        TOPIC_IF[Интерфейс определителя тем]
        
        subgraph agents["Фабрика агентов"]
            AGENT_LOGIC[Логика работы агентов]
        end
    end

    subgraph periphery_out["Периферия: сервисы"]
        STORAGE[Хранилище состояния]
        TEMPLATES[Хранилище шаблонов тем]
        LLM[LLM-провайдеры]
    end

    SRC --> preproc
    CONV --> preproc
    preproc --> COORD
    COORD --> doc
    COORD --> TOPIC_IF
    TOPIC_IF --> TEMPLATES
    doc --> STORAGE
    THEMATIC --> agents
    agents --> LLM
    VLM --> ARTIFACTS
    NAV --> ARTIFACTS
    THEMATIC --> ARTIFACTS
```

### 5.2. Потоки данных в пайплайне

```mermaid
flowchart LR
    subgraph input["Вход"]
        ARCHIVE[Архив]
        QUESTION[Вопрос?]
    end

    subgraph preproc["Препроцессор"]
        UNPACK[Распаковка]
        NORMALIZE[Нормализация]
        GROUP[Группировка]
    end

    COORD[Координатор]

    subgraph doc_processing["Обработка документа"]
        EXTRACT[Извлечение контента]
        STRUCT[Построение структуры]
        TOPICS[Определение тем]
        ANALYSIS[Тематический анализ]
        RESPONSE[Формирование ответа]
    end

    ARCHIVE --> UNPACK
    UNPACK --> NORMALIZE
    NORMALIZE --> GROUP
    GROUP -->|реестр документов| COORD
    QUESTION -->|вопрос| COORD
    COORD -->|для каждого документа| EXTRACT
    EXTRACT --> STRUCT
    STRUCT --> TOPICS
    TOPICS --> ANALYSIS
    ANALYSIS --> RESPONSE
    RESPONSE -->|ответ| COORD
```

### 5.3. Модель контент-агента

```mermaid
flowchart TB
    subgraph state["Хранимое состояние"]
        PROMPT[Системный промпт]
        TOOLS[Инструменты]
        HISTORY[История сообщений]
    end

    ACTIVATE[Активация]
    
    subgraph runtime["Время выполнения"]
        AGENT[Агент]
        LLM[LLM-провайдер]
        EXEC[Выполнение инструментов]
    end

    SAVE[Сохранение состояния]

    state --> ACTIVATE
    ACTIVATE --> AGENT
    AGENT <--> LLM
    AGENT <--> EXEC
    AGENT --> SAVE
    SAVE --> state
```

### 5.4. Граница ядро / периферия

```mermaid
flowchart TB
    subgraph core["ЯДРО"]
        COORD[Координатор обработки]
        DOC[Документ]
        GROUP_LOGIC[Логика группировки]
        AGENT_LOGIC[Логика агентов]
        TOPIC_IF[Интерфейс определителя тем]
    end

    subgraph periphery["ПЕРИФЕРИЯ"]
        subgraph adapters_in["Адаптеры входа"]
            FS[Файловая система]
            URL[URL]
            API_IN[API]
        end
        
        subgraph adapters_conv["Адаптеры конвертации"]
            GROUPDOCS[GroupDocs]
            CONVERTAPI[ConvertAPI]
        end
        
        subgraph adapters_storage["Адаптеры хранения"]
            FILES[Файлы JSON/YAML]
            DB[База данных]
        end
        
        subgraph adapters_llm["Адаптеры LLM"]
            CLAUDE[Claude]
            GPT[GPT]
            LOCAL[Локальные модели]
        end
        
        subgraph adapters_topics["Реализации определителя тем"]
            TPL[По шаблону]
            AUTO[Автоматически]
        end
    end

    adapters_in --> GROUP_LOGIC
    adapters_conv --> GROUP_LOGIC
    GROUP_LOGIC --> COORD
    COORD --> DOC
    TOPIC_IF --> adapters_topics
    AGENT_LOGIC --> adapters_llm
    DOC --> adapters_storage
```

---

## 6. Открытые вопросы

1. **Название «Документ» как компонента** — совпадает с концептуальным понятием, возможна путаница. Требуется ли другое название для компонента?

2. **Логика определения тем внутри ядра** — где именно: в координаторе или в документе? Пока не определено.

3. **Детализация фабрики агентов** — структура состояния, механизм активации, управление историей — требует проработки на следующем уровне.

4. **Обработка XLSX** — отложено, требует отдельной проработки.
