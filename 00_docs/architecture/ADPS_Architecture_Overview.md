# Agentic Document Processing System
## Архитектура: Обзор

**Версия:** 0.1
**Дата:** 2026-02-11

**Связанные документы:**
- Концептуальная модель (ADPS_Conceptual_Model.md)
- Архитектурная модель. Уровень 1 (ADPS_Architecture_L1.md)
- Архитектурная модель. Уровень 2 (ADPS_Architecture_L2.md)
- Архитектурная модель. Уровень 3 (ADPS_Architecture_L3.md)
- Модель данных. Уровень 4 (ADPS_Architecture_L4.md)

---

## 1. Структура архитектурной документации

Архитектура ADPS описана в пяти основных документах, организованных по уровням абстракции:

```
┌─────────────────────────────────────────────────────────────────┐
│  Концептуальная модель                                       │
│  (ADPS_Conceptual_Model.md)                                 │
│  Базовые понятия, агентская модель, навигация, выписки       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Уровень 1: Контексты и пайплайн                            │
│  (ADPS_Architecture_L1.md)                                  │
│  Контексты использования, 7 этапов обработки, ядро/периферия│
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Уровень 2: Компоненты                                      │
│  (ADPS_Architecture_L2.md)                                 │
│  Координатор, Препроцессор, Документ-юнит, Топик-провайдер  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Уровень 3: Сквозные сценарии                                │
│  (ADPS_Architecture_L3.md)                                  │
│  Сценарии A/B/C/D, агенты X/Q/topic/block, фазы обработки    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Уровень 4: Модель данных                                    │
│  (ADPS_Architecture_L4.md)                                 │
│  Структуры данных: Block, Topic, Matrix, Extract, AgentState │
└─────────────────────────────────────────────────────────────────┘
```

### Краткая характеристика уровней

| Уровень | Фокус | Основное содержание | Целевая аудитория |
|---------|-------|--------------------|-------------------|
| **Концептуальная модель** | Понятийный аппарат | Документ, файл, блок, тема, узел, выписка, контент-агент | Все заинтересованные стороны |
| **L1** | Что делает система | Контексты использования, пайплайн, граница ядро/периферия | Архитекторы, Product, Стейкхолдеры |
| **L2** | Из чего состоит | Компоненты, их ответственность, связи | Архитекторы, разработчики |
| **L3** | Как работает | Сквозные сценарии, динамика взаимодействия, агенты | Разработчики, аналитики |
| **L4** | Как хранит данные | Схемы данных, форматы, идентификаторы | Разработчики, DevOps |

---

## 2. Эволюция терминологии

В процессе разработки архитектуры термины уточнялись и менялись. Ниже приведены ключевые изменения, которые необходимо учитывать при чтении документов.

### 2.1. Топик-провайдер (актуальный термин)

| Документ | Используемый термин | Статус |
|----------|-------------------|--------|
| L2 | Определитель тем | ⚠️ Устаревший вариант |
| L3, L4 | Топик-провайдер | ✅ Актуальный термин |

**Рекомендация:** Использовать термин **«Топик-провайдер»** (TopicProvider).

> **Примечание:** В документе L2 термин «Определитель тем» использовался на ранних этапах проектирования. В L3-L4 он заменён на «Топик-провайдер», который точнее отражает суть компонента — предоставление набора тем для разбора на основе типа документа.

---

### 2.2. Фабрика агентов vs Тематический анализатор

Это **разные компоненты** с разными职责:

| Аспект | Фабрика агентов | Тематический анализатор |
|--------|----------------|------------------------|
| **Тип** | Паттерн проектирования | Компонент системы |
| **Назначение** | Создание агентов по запросу | Управление тематическим разбором |
| **Вхождение в документы** | L2 (как компонент) | L3 (внутри Документ-юнита) |
| **Зависит от LLM?** | Нет (фабрика) | Да (вероятно, использует LLM) |

**Фабрика агентов** — компонент из L2, реализующий паттерн Factory. Отвечает за создание инстансов агентов (контент-агентов) по запросу.

**Тематический анализатор** — компонент внутри Документ-юнита (L3). Отвечает за:
- Управление процессом тематического разбора
- Создание топик-агентов (может использовать Фабрику агентов)
- Координацию работы блок-агентов
- Формирование навигационной матрицы

> **Примечание:** Тематический анализатор может использовать Фабрику агентов для создания топик-агентов и блок-агентов. Эти компоненты не взаимоисключающие, а дополняющие.

---

### 2.3. Документ vs Документ-юнит

| Документ | Термин | Статус |
|----------|--------|--------|
| L2 | Документ | Упрощённый вариант |
| L3, L4 | Документ-юнит | Актуальный термин |

**Рекомендация:** Использовать **«Документ-юнит»** (DocumentUnit).

> **Примечание:** В L3 явно указано: *«Именуется «Документ» в L2»*. Это объясняет различие: L2 использует краткое наименование, L3-L4 — более точное.

---

### 2.4. Эволюция термина «контент-агент»

В концептуальной модели и L1-L2 термин **«контент-агент»** использовался как обобщающее понятие для всех агентов, работающих с контентом.

В L3-L4 этот термин детализирован на конкретные типы:

| Общий термин (Conceptual, L1-L2) | Конкретные типы (L3-L4) |
|--------------------------------|-------------------------|
| контент-агент | Агент X (Структурный экстрактор) |
| контент-агент | Агент Q (Агент запроса) |
| контент-агент | Топик-агент |
| контент-агент | Блок-агент |

**Рекомендация:**
- В архитектурных обсуждениях использовать конкретные типы агентов
- Термин «контент-агент» оставить как общее понятие для концептуальных обсуждений

> **Примечание:** Конкретизация терминологии в L3-L4 позволяет точнее описывать ответственности и взаимодействия между компонентами.

---

### 2.5. Выписка vs Extract

| Аспект | Термин | Использование |
|--------|--------|--------------|
| **Понятие** | Выписка | Концептуальная модель, L1-L3 |
| **Структура данных** | Extract | L4 (модель данных) |

**Рекомендация:** Использовать **«выписка»** как понятие, **`Extract`** как имя структуры данных в коде.

---

## 3. Сводная таблица терминов

| Категория | Актуальный термин | Устаревший вариант (если есть) | Английский аналог |
|-----------|-----------------|------------------------------|------------------|
| Компоненты | | | |
| | Топик-провайдер | Определитель тем | TopicProvider |
| | Документ-юнит | Документ (в L2) | DocumentUnit |
| | Тематический анализатор | — | ThematicAnalyzer |
| | Фабрика агентов | — | AgentFactory |
| Агенты | | | |
| | Агент X | — | Agent X / StructuralExtractor |
| | Агент Q | — | Agent Q / QueryAgent |
| | Топик-агент | контент-агент (частный случай) | TopicAgent |
| | Блок-агент | контент-агент (частный случай) | BlockAgent |
| Артефакты | | | |
| | Навигационная матрица | — | NavigationMatrix |
| | Выписка | — | Extract |
| | Столбец матрицы | — | MatrixColumn |
| Множества тем | | | |
| | Т1 | — | Topics from provider |
| | Т2 | — | Relevant topics |
| | Т3 | — | Additional topics |
| | Т_целевые | — | Target topics |
| | Т_фоновые | — | Background topics |

---

## 4. Ключевые архитектурные решения

### 4.1. Агентская модель

Система использует иерархию агентов:

```
Документ-юнит
├── Агент X (структурный экстрактор)
├── Агент Q (обработка запросов)
└── Тематический анализатор
    └── Топик-агенты
        └── Блок-агенты
            └── (вложенные блок-агенты)
```

**Ключевые принципы:**
- Каждый агент инкапсулирует: системный промпт, инструменты, историю, LLM-клиент
- LLM-клиент является внутренней частью агента (не показывается на диаграммах)
- Агенты создаются под конкретные задачи и уничтожаются после завершения

---

### 4.2. Разделение Ядро / Периферия

| Ядро (Core) | Периферия (Periphery) |
|------------|----------------------|
| Координатор | vlm-ocr-doc-reader |
| Препроцессор | LLM-провайдеры |
| Документ-юнит | Сервисы конвертации (DOCX → PDF) |
| Агенты (X, Q, topic, block) | Хранилище |

**Принцип:** Ядро содержит бизнес-логику, периферия — внешние зависимости, которые могут быть заменены.

---

### 4.3. Модель асинхронности

| Уровень | Взаимодействие | Модель |
|---------|----------------|--------|
| 1 | Внешняя система ↔ Координатор | Асинхронно (callback / polling) |
| 2 | Координатор ↔ Документ-юниты | Асинхронно (Координатор не блокируется) |
| 3 | Внутри Документ-юнита | Синхронно |

---

### 4.4. Dependency Injection

Связи между компонентами устанавливаются при инициализации:

```
Конфигурация (Топик-провайдер, Хранилище, Сервисы конвертации)
    ↓ DI
Координатор
    ↓ DI
Документ-юнит (получает необходимые зависимости)
```

Документ-юнит сам решает, когда вызывать Топик-провайдер.

---

## 5. Сквозные сценарии

| Сценарий | Описание | Статус |
|----------|----------|--------|
| **A** | Первичная обработка с вопросом | MVP |
| **B** | Повторный запрос к обработанному документу | MVP |
| **C** | Обработка без вопроса (подготовка документа) | MVP |
| **D** | MCP-сессия (итеративный анализ) | Бэклог |

**Сценарий A** покрывает все этапы пайплайна (1-7) и является основным для проверки архитектуры.

---

## 6. Открытые архитектурные вопросы

| # | Вопрос | Статус |
|---|--------|--------|
| 1 | Формат выписки: структура, ограничения на размер | Требует детализации |
| 2 | Мультидокументный запрос: кто координирует агрегацию? | Открыто |
| 3 | Обработка ошибок: недоступность LLM, конвертации, таймауты | Требует проработки |
| 4 | История агента Q: полная, без истории, заметки? | Открыто |
| 5 | Конкурентный разбор: повторный запрос во время фонового | Бэклог |

---

## 7. Рекомендации по использованию документов

### При разработке

1. **Начните с L1** — понимание пайплайна и контекстов использования
2. **Перейдите к L2** — изучение компонентов и их ответственности
3. **Изучите L3** — понимание сквозных сценариев и динамики
4. **Используйте L4** — работа со структурами данных

### При обсуждении архитектуры

1. Используйте актуальные термины из раздела 3
2. При ссылках на L2 учитывайте замены терминов (раздел 2)
3. Для конкретных агентов используйте типизированные названия (X, Q, topic, block)

### При реализации

1. Следуйте принципам DI и разделения ядро/периферия
2. Ориентируйтесь на сценарии L3 при разработке взаимодействий
3. Используйте структуры данных из L4 для хранения

---

## 8. История изменений

| Дата | Версия | Изменение |
|------|--------|-----------|
| 2026-02-11 | 0.1 | Создан документ с обзором архитектуры и словарём терминов |
