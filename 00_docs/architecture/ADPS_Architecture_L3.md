# Agentic Document Processing System
## Архитектурная модель. Уровень 3: Сквозные сценарии

**Версия:** 0.2  
**Дата:** 2026-02-02

**Связанные документы:**
- Концептуальная модель (ADPS_Conceptual_Model.md)
- Архитектурная модель. Уровень 1 (ADPS_Architecture_L1.md)
- Архитектурная модель. Уровень 2 (ADPS_Architecture_L2.md)

---

## 1. Введение

### 1.1. Назначение документа

Документ описывает сквозные сценарии работы системы ADPS — полный путь обработки от поступления архива до выдачи ответа. Сценарии верифицируют архитектуру, описанную в документах L1 и L2, и демонстрируют взаимодействие компонентов в динамике.

Документ предполагает знакомство читателя с:
- Концептуальной моделью ADPS (понятия: документ, файл, блок, тема/топик, узел, выписка, контент-агент)
- Архитектурной моделью L1 (пайплайн из 7 этапов, артефакты, ядро/периферия)
- Архитектурной моделью L2 (компоненты: Препроцессор, Координатор, Документ, Топик-провайдер, Фабрика агентов)

### 1.2. Краткое напоминание

**Пайплайн обработки (L1):**
1. Приём — получение архивов, опционально вопроса
2. Нормализация — приведение файлов к PDF
3. Группировка — определение принадлежности файлов к документам
4. Извлечение контента — обработка через vlm-ocr-doc-reader
5. Построение структуры — DAG блоков, оглавление
6. Тематический разбор — выделение тем, навигационная матрица, выписки
7. Обработка запросов — формирование ответов

**Ключевые компоненты (L2):**
- **Координатор** — точка входа, оркестрация обработки
- **Препроцессор** — приём, нормализация, группировка
- **Документ-юнит** — агрегация файлов, хранение артефактов, обработка запросов
- **Топик-провайдер** — опциональный модуль, поставляющий темы для разбора

### 1.3. Сценарии в скоупе

| Сценарий | Описание | Статус |
|----------|----------|--------|
| A | Первичная обработка с вопросом | MVP |
| B | Повторный запрос к обработанному документу | MVP |
| C | Обработка без вопроса (подготовка документа) | MVP |
| D | MCP-сессия (итеративный анализ) | Бэклог |

---

## 2. Глоссарий

### 2.1. Компоненты

| Термин | Определение |
|--------|-------------|
| Документ-юнит | Компонент, агрегирующий файлы одного логического документа и все артефакты его обработки. Именуется «Документ» в L2 |
| Препроцессор | Компонент, выполняющий приём, нормализацию и группировку файлов. Содержит внутренние модули: Распаковщик, Конвертер, Группировщик |
| Распаковщик | Модуль Препроцессора, извлекающий файлы из архивов |
| Конвертер | Модуль Препроцессора, преобразующий DOCX в PDF через внешние сервисы конвертации |
| Группировщик | Модуль Препроцессора, определяющий принадлежность файлов к логическим документам на основе анализа начальных страниц |
| Топик-провайдер | Опциональный модуль, поставляющий набор тем (Т1) для разбора документа на основе его типа или накопленного опыта. Вызывается из Документ-юнита |
| Тематический анализатор | Компонент внутри Документ-юнита, управляющий тематическим разбором и формированием навигационной матрицы |
| Структурный экстрактор | Обёртка над vlm-ocr-doc-reader, управляющая извлечением контента для построения структуры документа (DAG, оглавление). Также именуется Агент X |

### 2.2. Агенты

| Термин | Определение |
|--------|-------------|
| Агент Q | Агент запроса. Обрабатывает query от начала до конца: определяет нужные топики, инициирует их разбор, опрашивает топик-агентов, синтезирует ответ. Сохраняет историю между запросами |
| Агент X | Структурный экстрактор. Агент, управляющий извлечением структуры документа через vlm-ocr-doc-reader |
| Топик-агент | Агент, отвечающий за разбор одной темы. Управляет блок-агентами, заполняет столбец навигационной матрицы, формирует выписку |
| Блок-агент | Агент, извлекающий данные по теме из одного блока документа. При наличии подблоков создаёт вложенных блок-агентов |

### 2.3. Наборы тем

| Термин | Определение |
|--------|-------------|
| Т1 | Темы от Топик-провайдера — внешний набор тем, поставляемый на основе типа документа |
| Т2 | Подмножество Т1, определённое агентом Q как релевантное для текущего запроса |
| Т3 | Дополнительные темы, сформированные агентом Q, если Т1 недостаточно для ответа на запрос |
| Т_целевые | Объединение Т2 ∪ Т3 — темы, требующие приоритетного разбора для ответа на запрос |
| Т_фоновые | Разность Т1 \ Т2 — темы из Т1, не вошедшие в Т2, разбираемые асинхронно после выдачи ответа |
| Т_разобранные | Темы, уже разобранные и сохранённые в хранилище (для повторных запросов) |

### 2.4. Артефакты

| Термин | Определение |
|--------|-------------|
| Навигационная матрица | Таблица соответствия блоков документа и тем. Строки — блоки (элементы оглавления), столбцы — темы, ячейки — описание отражения темы в блоке |
| Столбец навигационной матрицы | Заполненный столбец матрицы по одной теме — результат работы топик-агента |
| Выписка | Эссе по теме, формируемое топик-агентом на основе данных, извлечённых блок-агентами. Содержит структурированное изложение того, как тема отражена в документе |
| document_id | Идентификатор документа, возвращаемый после обработки. Используется для последующих запросов |

---

## 3. Архитектурные принципы

### 3.1. Агентская модель

Агенты в ADPS — это компоненты, использующие LLM для выполнения задач. Каждый агент инкапсулирует:
- Системный промпт (инструкции)
- Набор инструментов
- Историю взаимодействия
- LLM-клиент (внутренний механизм обращения к внешним LLM)

LLM-клиент является внутренней частью агента и не показывается на диаграммах отдельно.

### 3.2. Иерархия агентов

```mermaid
flowchart TB
    subgraph DocUnit["Документ-юнит"]
        Q[Агент Q<br/>обработка запросов]
        X[Агент X<br/>структурный экстрактор]
        
        subgraph TA["Тематический анализатор"]
            TAgent[Топик-агент]
            BAgent[Блок-агент]
            
            TAgent -->|создаёт| BAgent
            BAgent -->|опционально| BAgent
        end
        
        Q -->|инициирует разбор| TAgent
        Q -->|опрашивает| TAgent
    end
```

### 3.3. Модель асинхронности

| Уровень | Взаимодействие | Модель |
|---------|----------------|--------|
| 1 | Внешняя система ↔ Координатор | Асинхронно (callback / polling статуса) |
| 2 | Координатор ↔ Документ-юниты | Асинхронно (Координатор не блокируется) |
| 3 | Внутри Документ-юнита | Синхронно |

Координатор может параллельно обрабатывать несколько документов из одного архива.

### 3.4. Dependency Injection

Связи между компонентами устанавливаются при создании (DI):

```mermaid
flowchart TB
    subgraph Config["Конфигурация системы"]
        TP[Топик-провайдер]
        Store[Хранилище]
        ConvSvc[Сервисы конвертации]
    end
    
    subgraph Core["Ядро"]
        Coord[Координатор]
        Doc[Документ-юнит]
    end
    
    Config -->|DI| Coord
    Coord -->|DI| Doc
```

При инициализации:
- Координатор получает ссылки на периферийные сервисы
- При создании Документ-юнита Координатор передаёт ему необходимые зависимости (включая Топик-провайдер)
- Документ-юнит сам решает, когда вызывать Топик-провайдер

### 3.5. Механизм уведомлений

Документ-юнит уведомляет Координатор о завершении через callback:

```
Координатор → Документ-юнит:
    process(files, doc_type, topic_provider, on_complete)
    
    on_complete: (document_id, status, error?) → void
```

Возможные реализации callback:
- Callback-функция
- Promise / Future
- События / подписка

---

## 4. Сценарий A: Первичная обработка с вопросом

### 4.1. Описание

**Входные данные:**
- Архив (ZIP) с файлами документа
- Вопрос (query) к документу

**Ожидаемый результат:**
- Ответ на вопрос

**Покрытие пайплайна:** все этапы (1-7)

### 4.2. Фазы сценария

| Фаза | Этапы пайплайна | Описание |
|------|-----------------|----------|
| I | 1-3 | Приём и нормализация |
| II | 4-5 | Извлечение и структура |
| III-V | 6-7 | Обработка запроса (агент Q) |
| VI | 6 | Фоновый разбор |

---

## 5. Фаза I: Приём и нормализация

### 5.1. Участники

- Внешняя система
- Координатор
- Препроцессор (Распаковщик, Конвертер, Группировщик)
- Периферия.Конвертация

### 5.2. Диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant Ext as Внешняя система
    participant Coord as Координатор
    participant Prep as Препроцессор
    participant Unpack as Распаковщик
    participant Conv as Конвертер
    participant ConvSvc as Периферия.Конвертация
    participant Grp as Группировщик

    Ext->>Coord: (архив, query)
    Coord->>Prep: архив
    Prep->>Unpack: архив
    Unpack->>Unpack: извлечение файлов
    Unpack-->>Prep: файлы (DOCX, PDF, ...)
    
    Prep->>Conv: DOCX-файлы
    Conv->>ConvSvc: DOCX
    ConvSvc-->>Conv: PDF
    Conv-->>Prep: PDF-файлы
    
    Prep->>Grp: все PDF-файлы
    Grp->>Grp: извлечение начальных страниц
    Grp->>Grp: рендеринг в изображения
    Grp->>Grp: анализ через VLM (заголовки, типы)
    Grp-->>Prep: группы файлов, типы документов
    
    Prep-->>Coord: реестр документов, маппинг
```

### 5.3. Внутренняя структура Препроцессора

```mermaid
flowchart LR
    subgraph Prep["Препроцессор"]
        Unpack[Распаковщик]
        Conv[Конвертер]
        Grp[Группировщик]
        
        Unpack --> Conv
        Conv --> Grp
    end
    
    subgraph Periphery["Периферия"]
        ConvSvc[Сервисы конвертации<br/>GroupDocs / ConvertAPI]
        VLMc[VLM-клиент]
    end
    
    Conv --> ConvSvc
    Grp --> VLMc
```

### 5.4. Выходные артефакты

- **Реестр документов** — список документов с идентификаторами, типами, описаниями
- **Маппинг** — соответствие: документ → список PDF-файлов

---

## 6. Фаза II: Извлечение и структура

### 6.1. Участники

- Координатор
- Документ-юнит
- Топик-провайдер (опционально, вызывается из Документ-юнита)
- Агент X (Структурный экстрактор)
- vlm-ocr-doc-reader
- Хранилище

### 6.2. Диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant Coord as Координатор
    participant Doc as Документ-юнит
    participant TP as Топик-провайдер
    participant X as Агент X
    participant VLM as vlm-ocr-doc-reader
    participant Store as Хранилище

    Coord->>Doc: создать(PDF-файлы, тип, topic_provider, query, callback)
    
    Doc->>X: извлечь структуру
    X->>VLM: извлечь контент (стратегия: структура)
    VLM-->>X: контент страниц
    X->>X: выделение заголовков, иерархии
    X-->>Doc: DAG, оглавление
    Doc->>Store: сохранить структуру
    
    opt Топик-провайдер передан
        Doc->>TP: get_topics(тип)
        TP-->>Doc: Т1
    end
    
    Note over Doc: Переход к обработке запроса
```

### 6.3. Роль Агента X

Агент X (Структурный экстрактор) — обёртка над vlm-ocr-doc-reader, которая:
- Задаёт стратегию извлечения для построения структуры
- Управляет порядком обработки страниц
- Выделяет заголовки и определяет иерархию
- Агрегирует результаты в DAG и оглавление

Выделение в отдельный компонент позволяет модифицировать логику извлечения структуры без изменения vlm-ocr-doc-reader.

### 6.4. Выходные артефакты

- **DAG блоков** — направленный ациклический граф структуры документа
- **Оглавление** — DAG с привязкой к диапазонам страниц
- **Т1** — темы от Топик-провайдера (если подключен)

---

## 7. Фазы III-V: Обработка запроса (Агент Q)

### 7.1. Общая логика

Агент Q обрабатывает запрос от начала до конца:
1. Определяет, какие топики нужны для ответа
2. Инициирует разбор недостающих топиков
3. Опрашивает топик-агентов
4. Синтезирует ответ

Определение топиков — побочный эффект работы Q, а не отдельная фаза «планирования».

### 7.2. Диаграмма: Первичный запрос

```mermaid
sequenceDiagram
    autonumber
    participant Doc as Документ-юнит
    participant Q as Агент Q
    participant TA as Тематический анализатор
    participant TAgent as Топик-агент
    participant Store as Хранилище
    participant Coord as Координатор

    Doc->>Q: (query, Т1)
    
    rect rgb(245, 255, 245)
        Note over Q: Определение нужных топиков
        Q->>Q: Какие аспекты нужны для ответа на query?
        Q->>Q: Какие из Т1 релевантны? → Т2
        Q->>Q: Нужны ли дополнительные темы? → Т3
        Note over Q: Т_целевые = Т2 ∪ Т3<br/>Т_фоновые = Т1 \ Т2
    end
    
    rect rgb(255, 245, 245)
        Note over Q,Store: Тематический разбор Т_целевые
        Q->>TA: разобрать Т_целевые
        loop по каждой теме
            TA->>TAgent: создать(тема)
            Note over TAgent: разбор всех блоков
            TAgent-->>TA: столбец матрицы, выписка
        end
        TA->>Store: сохранить матрицу, выписки
        TA-->>Q: разбор завершён
    end
    
    rect rgb(245, 245, 255)
        Note over Q,TAgent: Сбор ответа
        loop по каждому топику из Т_целевые
            Q->>TAgent: вопрос по топику
            TAgent-->>Q: ответ
        end
        Q->>Q: синтез ответа на query
    end
    
    Q-->>Doc: ответ
    Doc-->>Coord: callback(document_id, ответ)
```

---

## 8. Работа топик-агента (детализация)

### 8.1. Описание

Топик-агент отвечает за полный разбор одной темы:
1. Просматривает **все** блоки документа (не только «релевантные» по названию)
2. Создаёт блок-агентов для извлечения данных
3. Заполняет столбец навигационной матрицы
4. Формирует выписку — эссе по теме

### 8.2. Диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant TA as Тематический анализатор
    participant TAgent as Топик-агент
    participant BAgent as Блок-агент
    participant VLM as vlm-ocr-doc-reader

    TA->>TAgent: создать(тема)
    TAgent->>TAgent: получить список всех блоков из оглавления
    
    loop по всем блокам документа
        TAgent->>BAgent: создать(блок, тема)
        BAgent->>VLM: получить контент блока
        VLM-->>BAgent: контент
        BAgent->>BAgent: извлечь данные по теме
        
        opt блок содержит подблоки
            loop по подблокам
                BAgent->>BAgent: создать вложенного блок-агента
            end
        end
        
        BAgent-->>TAgent: данные блока (или «тема не отражена»)
    end
    
    TAgent->>TAgent: заполнить столбец навигационной матрицы
    TAgent->>TAgent: сформировать выписку (эссе по теме)
    TAgent-->>TA: столбец матрицы, выписка
```

### 8.3. Примечания

- **Просмотр всех блоков** — топик-агент не фильтрует блоки по названию, поскольку релевантная информация может находиться в блоках с неочевидными заголовками
- **Столбец навигационной матрицы** — результат работы топик-агента; каждая ячейка содержит описание того, как тема отражена в соответствующем блоке (или отметку об отсутствии)
- **Выписка** — структурированное эссе, обобщающее данные из всех блоков по теме

---

## 9. Фаза VI: Фоновый разбор

### 9.1. Описание

После выдачи ответа Документ-юнит асинхронно разбирает оставшиеся темы из Т1, которые не вошли в Т2 (Т_фоновые = Т1 \ Т2). Это внутренняя оптимизация — Координатор не знает о разделении на Т2/Т3/Т_фоновые.

### 9.2. Диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant Doc as Документ-юнит
    participant TA as Тематический анализатор
    participant TAgent as Топик-агент
    participant Store as Хранилище

    Note over Doc,Store: Асинхронно, после возврата ответа<br/>Т_фоновые = Т1 \ Т2

    Doc->>TA: разобрать Т_фоновые
    
    par параллельно по каждой теме
        TA->>TAgent: создать(тема₁)
        Note over TAgent: разбор всех блоков
        TAgent-->>TA: столбец матрицы, выписка
    and
        TA->>TAgent: создать(тема₂)
        TAgent-->>TA: столбец матрицы, выписка
    and
        TA->>TAgent: создать(темаₙ)
        TAgent-->>TA: столбец матрицы, выписка
    end
    
    TA->>Store: сохранить матрицу, выписки
```

### 9.3. Примечания

- Топик-агенты могут работать **параллельно**
- Результаты сохраняются в Хранилище и будут доступны при последующих запросах
- Координатор и Внешняя система не ожидают завершения фонового разбора

---

## 10. Обзорная диаграмма сценария A

```mermaid
sequenceDiagram
    autonumber
    participant Ext as Внешняя система
    participant Coord as Координатор
    participant Prep as Препроцессор
    participant Doc as Документ-юнит
    participant TP as Топик-провайдер
    participant Q as Агент Q

    Ext->>Coord: (архив, query)
    
    rect rgb(240, 248, 255)
        Note over Coord,Prep: Фаза I: Приём и нормализация
        Coord->>Prep: архив
        Prep-->>Coord: реестр документов, маппинг
    end
    
    rect rgb(255, 250, 240)
        Note over Coord,Doc: Фаза II: Извлечение и структура
        Coord->>Doc: создать(PDF-файлы, тип, topic_provider, query, callback)
        Note over Doc: Агент X → DAG, оглавление
        opt Топик-провайдер передан
            Doc->>TP: get_topics(тип)
            TP-->>Doc: Т1
        end
    end
    
    rect rgb(245, 255, 245)
        Note over Doc,Q: Фазы III-V: Обработка запроса
        Doc->>Q: (query, Т1)
        Note over Q: Определение Т_целевые, Т_фоновые
        Note over Q: Разбор Т_целевые (топик-агенты)
        Note over Q: Сбор ответа
        Q-->>Doc: ответ
    end
    
    Doc-->>Coord: callback(document_id, ответ)
    Coord-->>Ext: ответ
    
    rect rgb(245, 245, 245)
        Note over Doc: Фаза VI: Фоновый разбор Т_фоновые (асинхронно)
    end
```

---

## 11. Сценарий B: Повторный запрос

### 11.1. Описание

**Предусловия:**
- Документ-юнит создан и содержит DAG, оглавление
- Возможно наличие ранее разобранных тем (Т_разобранные)
- Агент Q сохраняет историю между запросами

**Входные данные:**
- document_id
- Вопрос (query)

**Отличия от сценария A:**

| Аспект | Сценарий A | Сценарий B |
|--------|------------|------------|
| Фаза I | Выполняется | Пропускается |
| Фаза II | Выполняется | Пропускается |
| Источник тем | Т1 от Топик-провайдера | Т_разобранные из Хранилища |
| Создание Документ-юнита | Да | Нет (уже существует) |

### 11.2. Диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant Ext as Внешняя система
    participant Coord as Координатор
    participant Doc as Документ-юнит
    participant Q as Агент Q
    participant TA as Тематический анализатор
    participant TAgent as Топик-агент
    participant Store as Хранилище

    Ext->>Coord: (document_id, query)
    Coord->>Doc: query
    Doc->>Q: query
    
    Note over Q: Агент Q сохраняет историю<br/>предыдущих запросов
    
    Q->>Store: получить Т_разобранные
    Store-->>Q: Т_разобранные
    
    rect rgb(245, 255, 245)
        Note over Q: Определение нужных топиков
        Q->>Q: Какие аспекты нужны для query?
        Q->>Q: Т_готовы = нужные ∩ Т_разобранные
        Q->>Q: Т_доразобрать = нужные \ Т_разобранные
    end
    
    opt Т_доразобрать непусто
        rect rgb(255, 245, 245)
            Note over Q,Store: Дозабор недостающих тем
            Q->>TA: разобрать Т_доразобрать
            loop по каждой теме
                TA->>TAgent: создать(тема)
                TAgent-->>TA: столбец матрицы, выписка
            end
            TA->>Store: сохранить
            TA-->>Q: готово
        end
    end
    
    rect rgb(245, 245, 255)
        Note over Q,TAgent: Сбор ответа
        loop по нужным топикам
            Q->>TAgent: вопрос
            TAgent-->>Q: ответ
        end
        Q->>Q: синтез ответа (с учётом истории)
    end
    
    Q-->>Doc: ответ
    Doc-->>Coord: callback(document_id, ответ)
    Coord-->>Ext: ответ
```

### 11.3. Примечания

1. **История агента Q** — сохраняется между запросами в рамках одного Документ-юнита. Возможные варианты для будущих экспериментов:
   - Полная история диалога
   - Без истории (каждый запрос как новый)
   - Заметки с ранее заданными вопросами и ответами

2. **Ограничение MVP** — в начальных версиях избегать повторных запросов во время фонового разбора (см. Приложение Б)

---

## 12. Сценарий C: Обработка без вопроса

### 12.1. Описание

**Входные данные:**
- Архив (ZIP) с файлами документа
- Вопрос отсутствует

**Ожидаемый результат:**
- document_id (документ готов к запросам)

**Варианты:**

| Вариант | Топик-провайдер | Тематический разбор |
|---------|-----------------|---------------------|
| C1 | Подключен | Полный разбор по Т1 |
| C2 | Не подключен | Только структура (DAG, оглавление) |

### 12.2. Диаграмма C1: С Топик-провайдером

```mermaid
sequenceDiagram
    autonumber
    participant Ext as Внешняя система
    participant Coord as Координатор
    participant Prep as Препроцессор
    participant Doc as Документ-юнит
    participant TP as Топик-провайдер
    participant X as Агент X
    participant TA as Тематический анализатор
    participant TAgent as Топик-агент
    participant Store as Хранилище

    Ext->>Coord: архив (без query)
    
    rect rgb(240, 248, 255)
        Note over Coord,Prep: Фаза I: Приём и нормализация
        Coord->>Prep: архив
        Prep-->>Coord: реестр документов, маппинг
    end
    
    loop по каждому документу (параллельно)
        Coord->>Doc: создать(PDF-файлы, тип, topic_provider, callback)
        Note over Coord: Не ждёт завершения
        
        rect rgb(255, 250, 240)
            Note over Doc,Store: Фаза II: Извлечение и структура
            Doc->>X: извлечь структуру
            X-->>Doc: DAG, оглавление
            Doc->>Store: сохранить структуру
        end
        
        rect rgb(245, 255, 245)
            Note over Doc,TP: Получение тем
            Doc->>TP: get_topics(тип)
            TP-->>Doc: Т1
        end
        
        rect rgb(255, 245, 245)
            Note over Doc,Store: Полный тематический разбор Т1
            Doc->>TA: разобрать Т1
            
            par параллельно по каждой теме
                TA->>TAgent: создать(тема)
                TAgent-->>TA: столбец матрицы, выписка
            end
            
            TA->>Store: сохранить матрицу, выписки
        end
        
        Doc-->>Coord: callback(document_id, ready)
    end
    
    Note over Coord: Собрал все callback-и
    Coord-->>Ext: готово (список document_id)
```

### 12.3. Диаграмма C2: Без Топик-провайдера

```mermaid
sequenceDiagram
    autonumber
    participant Ext as Внешняя система
    participant Coord as Координатор
    participant Prep as Препроцессор
    participant Doc as Документ-юнит
    participant X as Агент X
    participant Store as Хранилище

    Ext->>Coord: архив (без query)
    
    rect rgb(240, 248, 255)
        Note over Coord,Prep: Фаза I: Приём и нормализация
        Coord->>Prep: архив
        Prep-->>Coord: реестр документов, маппинг
    end
    
    loop по каждому документу (параллельно)
        Coord->>Doc: создать(PDF-файлы, тип, topic_provider=null, callback)
        
        rect rgb(255, 250, 240)
            Note over Doc,Store: Фаза II: Извлечение и структура
            Doc->>X: извлечь структуру
            X-->>Doc: DAG, оглавление
            Doc->>Store: сохранить структуру
        end
        
        Note over Doc: Тематический разбор не выполняется<br/>Документ готов к запросам
        
        Doc-->>Coord: callback(document_id, ready)
    end
    
    Coord-->>Ext: готово (список document_id)
```

### 12.4. Примечания

1. **Возвращаемое значение** — `document_id` для последующих запросов (сценарий B)

2. **Вариант C1** — полезен для «предзагрузки» типовых документов с известной структурой тем

3. **Вариант C2** — минимальная подготовка; тематический разбор произойдёт при первом запросе

4. **Параллельность** — Координатор не блокируется; при нескольких документах в архиве обработка идёт параллельно

---

## 13. Компонентная модель (уточнение L2)

### 13.1. Структура Препроцессора

Препроцессор — не монолитный компонент. Внутренняя структура:

| Модуль | Ответственность | Зависимости |
|--------|-----------------|-------------|
| Распаковщик | Извлечение файлов из архивов | — |
| Конвертер | Преобразование DOCX → PDF | Периферия.Конвертация (GroupDocs, ConvertAPI) |
| Группировщик | Определение принадлежности файлов к документам | VLM-клиент |

### 13.2. Структура Документ-юнита

| Компонент | Ответственность |
|-----------|-----------------|
| Агент X | Извлечение структуры (DAG, оглавление) |
| Агент Q | Обработка запросов, история диалога |
| Тематический анализатор | Управление тематическим разбором, создание топик-агентов |
| Навигационный слой | Оглавление, навигационная матрица, поиск контента |

### 13.3. Диаграмма компонентов

```mermaid
flowchart TB
    subgraph Coord["Координатор"]
    end
    
    subgraph Prep["Препроцессор"]
        Unpack[Распаковщик]
        Conv[Конвертер]
        Grp[Группировщик]
    end
    
    subgraph TP["Топик-провайдер"]
    end
    
    subgraph DocUnit["Документ-юнит"]
        X[Агент X]
        Q[Агент Q]
        TA[Тематический анализатор]
        Nav[Навигационный слой]
        
        subgraph Agents["Агенты разбора"]
            TAgent[Топик-агенты]
            BAgent[Блок-агенты]
        end
        
        TA --> TAgent
        TAgent --> BAgent
        Q --> TA
        Q --> TAgent
    end
    
    subgraph Periphery["Периферия"]
        ConvSvc[Сервисы конвертации]
        VLM[vlm-ocr-doc-reader]
        Store[(Хранилище)]
    end
    
    Coord --> Prep
    Coord -->|DI| DocUnit
    DocUnit -->|вызывает| TP
    
    Conv --> ConvSvc
    Grp --> VLM
    X --> VLM
    BAgent --> VLM
    DocUnit --> Store
```

---

## 14. Открытые вопросы

| # | Вопрос | Контекст |
|---|--------|----------|
| 1 | Формат выписки | Требует детализации: структура, ограничения на размер, способ использования при ответе |
| 2 | Мультидокументный запрос | Если запрос требует данных из нескольких документов архива — кто координирует агрегацию ответов? |
| 3 | Обработка ошибок | Сценарии ошибок (недоступность LLM, ошибки конвертации, таймауты) требуют отдельной проработки |

---

## Приложение А. Сводка по агентам

| Агент | Буква | Создаётся | Управляет | Результат |
|-------|-------|-----------|-----------|-----------|
| Структурный экстрактор | X | Документ-юнит | vlm-ocr-doc-reader | DAG, оглавление |
| Агент запроса | Q | Документ-юнит | Топик-агенты | Ответ на query |
| Топик-агент | — | Тематический анализатор | Блок-агенты | Столбец матрицы, выписка |
| Блок-агент | — | Топик-агент | Вложенные блок-агенты | Данные по теме из блока |

## Приложение Б. Бэклог: Конкурентный разбор

**Статус:** не входит в начальные релизы

### Контекст

Повторный запрос поступает в момент, когда ведётся фоновый тематический разбор. В MVP избегаем этой ситуации.

### Будущее решение

```mermaid
sequenceDiagram
    autonumber
    participant Doc as Документ-юнит
    participant Q as Агент Q
    participant TA as Тематический анализатор
    participant Store as Хранилище

    Note over TA: Фоновый разбор Т_фоновые<br/>в процессе...

    Doc->>Q: query
    
    Q->>Store: получить статусы тем
    Store-->>Q: Т_разобранные, Т_в_процессе
    
    rect rgb(245, 255, 245)
        Note over Q: Определение нужных топиков
        Q->>Q: Какие аспекты нужны для query?
        Q->>Q: Т_готовы = нужные ∩ Т_разобранные
        Q->>Q: Т_ожидать = нужные ∩ Т_в_процессе
        Q->>Q: Т_новые = нужные \ (Т_разобранные ∪ Т_в_процессе)
    end
    
    opt Т_новые непусто
        Q->>TA: разобрать Т_новые
        Note over TA: Запуск параллельно<br/>с фоновым разбором
    end
    
    opt Т_ожидать непусто
        rect rgb(255, 250, 230)
            Note over Q,TA: Ожидание завершения разбора
            loop пока Т_ожидать не разобраны
                Q->>Store: проверить статус Т_ожидать
                Store-->>Q: статусы
            end
        end
    end
    
    rect rgb(245, 245, 255)
        Note over Q: Сбор ответа
        Note over Q: (все нужные темы готовы)
    end
    
    Q-->>Doc: ответ
```

### Ключевые элементы

| Элемент | Описание |
|---------|----------|
| Т_в_процессе | Темы, находящиеся на тематическом разборе |
| Т_ожидать | Пересечение нужных тем и Т_в_процессе — агент Q ждёт их завершения |
| Т_новые | Темы, которых нет ни в разобранных, ни в процессе — инициируется новый разбор |

## Приложение В. Бэклог: MCP-сессия (сценарий D)

**Статус:** не входит в начальные релизы

### Описание

Итеративный анализ документа через MCP-клиент (например, Claude). Многократные запросы с накоплением контекста.

### Ключевые особенности

1. **session_id** — идентификатор сессии для привязки истории диалога
2. **Персистентность агента Q** — сохраняет полную историю между запросами сессии
3. **Накопление тематического разбора** — каждый запрос может добавлять новые темы
4. **Работа с несколькими документами** — сессия может включать несколько document_id

### Управление сессией

- Явного завершения сессии нет
- История хранится с датой последнего сообщения
- Очистка по таймауту (решение о сроках — позже)

### Примерная диаграмма

```mermaid
sequenceDiagram
    autonumber
    participant MCP as MCP-клиент
    participant Coord as Координатор
    participant Doc as Документ-юнит
    participant Q as Агент Q

    MCP->>Coord: архив
    Coord-->>MCP: document_id
    
    loop Итерации сессии
        MCP->>Coord: (session_id, document_id, query)
        Coord->>Doc: query
        Doc->>Q: query
        Note over Q: История сессии
        Q-->>Doc: ответ
        Doc-->>Coord: ответ
        Coord-->>MCP: ответ
    end
```

## Приложение Г. Сводка по сценариям

| Сценарий | Вход | Выход | Фазы | Статус |
|----------|------|-------|------|--------|
| A | Архив + query | Ответ | I-VI | MVP |
| B | document_id + query | Ответ | III-V (+ дозабор) | MVP |
| C1 | Архив (ТП подключен) | document_id | I-II + разбор Т1 | MVP |
| C2 | Архив (ТП не подключен) | document_id | I-II | MVP |
| D | session_id + document_id + query | Ответ | III-V (итеративно) | Бэклог |
