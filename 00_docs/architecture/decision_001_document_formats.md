# Decision 001: Поддерживаемые форматы документов

**Статус:** Принято (обновлено)
**Дата:** 2025-01-23
**Контекст:** Tech Lead, вопросы по Итерации 2

---

## Контекст

При планировании Document Parser и Document Skeleton неясно какие форматы входных файлов поддерживать. Реальные документы (регламенты, отчеты) поступают в разных форматах:
- PDF (text-based и сканы)
- Excel с несколькими листами
- DOCX
- ZIP-архивы с наборами файлов

У пользователя уже есть работающий VLM-OCR модуль (PoC).

---

## Решение

**VLM-OCR как унифицированный экстрактор для всех форматов.**

### Unified pipeline для текстовых данных

```
Любой формат (DOCX / text-PDF / scan-PDF)
         ↓
    Конвертация в PDF
         ↓
    Рендер страниц в PNG
         ↓
    VLM-OCR с extractive prompts
         ↓
    DocumentSkeleton
```

**Принцип:** Весь текст (включая структуру) извлекается через VLM-OCR. Не используется нативный парсинг PDF/DOCX.

**Обоснование:**
- Снижение риска промпт-инъекций (текст идет через картинку)
- Единый pipeline для всех форматов
- VLM-OCR может извлекать не только текст, но и структуру, и описания схем/изображений

---

## Обработка таблиц (гибридный подход)

Таблицы требуют специальной обработки из-за разных типов:

### Классификация таблиц

```
1. VLM-OCR анализирует каждую таблицу
2. Классифицирует:
   - Тип А: Числовые данные (для вычислений)
   - Тип Б: Текстовая матрица (структурированный текст)
```

### Extraction по типу

| Тип | Источник | Метод обработки |
|-----|----------|-----------------|
| **Тип А (числовые)** | Исходный файл (Excel/PDF) | Pandas → computations |
| **Тип Б (текстовые)** | VLM-OCR с картинки | Cell Flattening |

**Почему так:**
- Числовые таблицы: точность данных, возможность вычислений
- Текстовые таблицы: снижение риска промпт-инъекций (через картинку)

---

## Поддерживаемые форматы (v1.0)

| Формат | Конвертация | Приоритет |
|--------|-------------|-----------|
| **PDF (любой)** | Уже PDF | High |
| **Excel (.xlsx)** | Встроенный конвертер | High |
| **DOCX** | Встроенный конвертер | Medium |
| **ZIP** | Распаковка → рекурсивная обработка | Medium |

### Архитектура модуля обработки

```
┌─────────────────────────────────────────────────────────┐
│                    DocumentProcessor                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │         VLM-OCR Extractor (основной путь)         │   │
│  │                                                   │   │
│  │   1. Конвертация → PDF                            │   │
│  │   2. Рендер → PNG (постранично)                   │   │
│  │   3. VLM-OCR с prompts:                           │   │
│  │      - текст + структура                          │   │
│  │      - описание схем/изображений                  │   │
│  │      - классификация таблиц                       │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Table Extractor (числовые таблицы)        │   │
│  │                                                   │   │
│  │   - Из исходного файла (Excel/PDF)               │   │
│  │   - Pandas DataFrame                             │   │
│  │   - Используется для computations                │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │            Unifier                                │   │
│  │  (агрегирует в DocumentSkeleton)                  │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## Обоснование

1. **Единый экстрактор:** VLM-OCR для всех форматов проще чем поддерживать несколько парсеров

2. **Безопасность:** Промпт-инъекции mitigated через картинку (текст не виден LLM напрямую)

3. **Структура + описание:** VLM-OCR может извлекать не только текст, но и:
   - Иерархию заголовков
   - Описания схем и изображений
   - Семантику таблиц

4. **Числовые таблицы из исходника:** Pandas точнее для вычислений чем VLM

---

## Последствия

### Для реализации

- VLM-OCR модуль — **основная зависимость** для извлечения текста
- Table Extractor — только для числовых таблиц (из исходного файла)
- Additional tasks:
  - Table Classifier (определить Тип А vs Тип Б)
  - Cell Flattening через VLM-OCR для текстовых таблиц

### Для архитектуры

- DocumentProcessor делегирует VLM-OCR для всех текстовых данных
- Числовые таблицы: гибридный путь (из исходника → Pandas)
- Текстовые таблицы: через VLM-OCR → Cell Flattening

### VLM-OCR API (контракт)

Вход:
- Массив PNG-изображений страниц
- Extractive prompts (текст, структура, таблицы, схемы)

Выход:
- Текст документа
- Структура (заголовки, иерархия)
- Таблицы с классификацией
- Описания схем/изображений

---

## Связанные решения

- **ADR-002:** Мультидокументность (как рассматривать набор файлов)
- **ADR-003:** Интеграция VLM-OCR модуля (детали API)
