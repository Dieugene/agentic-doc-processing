# Технический план: Converter (DOCX/Excel/TXT → PDF)

## 1. Анализ задачи

Реализовать модуль конвертации документов различных форматов (DOCX, Excel, TXT) в унифицированный PDF для последующего рендеринга в PNG и обработки VLM-OCR. Модуль должен поддерживать auto-detection по расширению, обрабатывать ошибки конвертации и обеспечивать очистку временных PDF файлов.

## 2. Текущее состояние

Кодовая база пуста (новый проект). Необходимо создать структуру модуля с нуля.

Существующий контекст:
- ADR-001 определяет unified pipeline: все форматы → PDF → PNG → VLM-OCR
- Интерфейс Converter определён в task_brief_01.md

## 3. Предлагаемое решение

### 3.1. Общий подход

**Pure Python решение без внешних зависимостей:**
- DOCX → PDF: python-docx + fpdf2
- Excel → PDF: openpyxl + fpdf2
- TXT → PDF: fpdf2
- PDF → без конвертации (return as-is)

**Обоснование:**
- Не требует установки LibreOffice
- Легко деплоить в Docker
- Контроль над процессом конвертации
- Достаточно для v1.0

### 3.2. Компоненты

#### FileType (enum)
- **Назначение:** Перечисление поддерживаемых форматов
- **Расположение:** `02_src/processing/converter.py`
- **Значения:** PDF, DOCX, XLSX, TXT, UNKNOWN

#### Converter
- **Назначение:** Конвертация файлов в PDF
- **Интерфейс:**
  - `convert_to_pdf(file_path, file_type=None) -> str`
  - `detect_file_type(file_path) -> FileType`
  - `_convert_docx_to_pdf(docx_path) -> str`
  - `_convert_xlsx_to_pdf(xlsx_path) -> str`
  - `_convert_txt_to_pdf(txt_path) -> str`
- **Зависимости:** python-docx, openpyxl, fpdf2, tempfile

#### ConversionError
- **Назначение:** Кастомный exception для ошибок конвертации
- **Наследование:** Exception

### 3.3. Структуры данных

**FileType (Enum):**
```python
class FileType(str, Enum):
    PDF = "pdf"
    DOCX = "docx"
    XLSX = "xlsx"
    TXT = "txt"
    UNKNOWN = "unknown"
```

**ConversionError:**
```python
class ConversionError(Exception):
    """Raised when file conversion fails"""
    def __init__(self, file_type: str, details: str):
        self.file_type = file_type
        self.details = details
```

### 3.4. Ключевые алгоритмы

#### detect_file_type
1. Извлечь расширение из file_path (os.path.splitext)
2. Привести к нижнему регистру
3. Сопоставить с FileType enum
4. Вернуть UNKNOWN если нет сопоставления

#### convert_to_pdf
1. Если file_type не указан → detect_file_type
2. Если UNKNOWN → raise ValueError
3. Если PDF → вернуть исходный путь (без конвертации)
4. Иначе → вызвать соответствующий приватный метод (_convert_*_to_pdf)
5. Вернуть путь к временному PDF файлу

#### _convert_docx_to_pdf
1. Открыть DOCX через python-docx (Document)
2. Создать PDF через fpdf2 (FPDF)
3. Для каждого параграфа в документе:
   - Добавить страницу если нужно
   - Применить стиль (bold, italic, size)
   - Добавить текст (multi_cell для переносов)
4. Сохранить во временный файл (tempfile.NamedTemporaryFile)
5. Вернуть путь к временному файлу

#### _convert_xlsx_to_pdf
1. Открыть XLSX через openpyxl (load_workbook)
2. Создать PDF через fpdf2
3. Для каждого листа:
   - Добавить новую страницу PDF с заголовком листа
   - Для каждой строки:
     - Для каждой ячейки:
       - Добавить в PDF с табличной разметкой
4. Сохранить во временный файл
5. Вернуть путь к временному файлу

**Особенности Excel:**
- Каждый лист = отдельная страница PDF с заголовком
- Табличная структура должна быть сохранена
- Ширина колонок масштабируется под ширину страницы A4

#### _convert_txt_to_pdf
1. Прочитать файл с auto-detected encoding (utf-8, cp1251)
2. Создать PDF через fpdf2 (моноширинный шрифт Courier)
3. Добавить текст с переносами строк
4. Сохранить во временный файл
5. Вернуть путь к временному файлу

### 3.5. Изменения в существующем коде

Новый модуль, изменений в существующем коде нет.

### 3.6. Структура проекта

```
02_src/
└── processing/
    ├── __init__.py
    ├── converter.py           # FileType, Converter, ConversionError
    └── tests/
        ├── __init__.py
        ├── test_converter.py
        └── fixtures/
            ├── sample.docx
            ├── sample.xlsx
            └── sample.txt

04_logs/
└── converter/
    └── conversion.log         # Опционально: логи конверсий
```

### 3.7. Управление временными файлами

**Стратегия:** Очистка через context manager

**Вариант A (рекомендуется):** Позволить вызывающему коду управлять временными файлами
- Converter возвращает путь к временному файлу
- Вызывающий код (Renderer) удаляет PDF после рендеринга в PNG

**Вариант B:** Использовать tempfile с автоматической очисткой
- tempfile.NamedTemporaryFile(delete=False)
- atexit.register для cleanup

**Решение для v1.0:** Вариант A — ответственность за очистку на вызывающей стороне (Renderer). Это позволяет держать PDF для отладки если нужно.

## 4. План реализации

1. **Шаг 1:** Создать структуру директорий `02_src/processing/`
2. **Шаг 2:** Реализовать FileType enum и ConversionError
3. **Шаг 3:** Реализовать detect_file_type()
4. **Шаг 4:** Реализовать _convert_txt_to_pdf() (простейший случай)
5. **Шаг 5:** Реализовать _convert_docx_to_pdf()
6. **Шаг 6:** Реализовать _convert_xlsx_to_pdf()
7. **Шаг 7:** Реализовать convert_to_pdf() как диспетчер
8. **Шаг 8:** Создать sample файлы fixtures
9. **Шаг 9:** Написать unit тесты

## 5. Технические критерии приемки

- [ ] TC-001: DOCX конвертируется в корректный PDF (сохраняется текст, структура)
- [ ] TC-002: Excel (многолистовый) конвертируется: каждый лист = страница с заголовком
- [ ] TC-003: TXT с кириллицей конвертируется корректно
- [ ] TC-004: PDF файл возвращается как-is (без конвертации)
- [ ] TC-005: Неподдерживаемый формат вызывает ValueError
- [ ] TC-006: Ошибка конвертации вызывает ConversionError
- [ ] TC-007: Временный PDF файл создается и доступен для чтения
- [ ] TC-008: Unit тесты покрывают все форматы

## 6. Важные детали для Developer

### Кодировки (TXT)
- TXT файлы могут быть в UTF-8 или CP1251 (Windows)
- Используй chardet или пробуй UTF-8 с fallback на CP1251
- Добавь в тесты sample.txt с кириллицей

### Размер файлов
- Нет ограничений на размер входных файлов в v1.0
- Для больших DOCX (>100 страниц) конвертация может быть медленной
- Рассмотри добавление progress callback в будущих версиях

### Excel таблицы
- openpyxl не сохраняет стиль ячеек (цвета, границы)
- Для v1.0 это допустимо — передавать данные важнее
- Ширина колонок: масштабируй пропорционально ширине страницы A4 (210mm)

### DOCX форматирование
- python-docx теряет часть форматирования (позиционирование, отступы)
- Сохраняй: параграфы, bold/italic, размер шрифта
- Изображения в DOCX игнорируй в v1.0

### Логирование
- Логи конверсии в `04_logs/converter/conversion.log`
- Формат: timestamp, file_type, input_file, output_file, status (success/error)
- Используй Python logging module

### Зависимости
Добавить в `requirements.txt` или `pyproject.toml`:
```
python-docx>=1.0.0
openpyxl>=3.1.0
fpdf2>=2.7.0
chardet>=5.0.0
```

## 7. Тестовые fixture'ы

### sample.docx
- 2-3 параграфа текста
- Разные стили (обычный, bold, italic)
- Кириллица

### sample.xlsx
- 2-3 листа
- Каждая таблица 5x5 с данными
- Заголовки колонок
- Кириллица

### sample.txt
- 10-15 строк текста
- Кириллица
- Переносы строк

## 8. Принятые решения по "Ключевые решения"

### 1. Библиотеки для конвертации
**Решение:** python-docx + fpdf2 (DOCX), openpyxl + fpdf2 (Excel)
**Обоснование:** Pure Python, нет внешних зависимостей типа LibreOffice, легко деплоить

### 2. Многолистовые Excel
**Решение:** Каждый лист = отдельная страница PDF с заголовком названия листа
**Обоснование:** Сохраняет структуру Excel документа для VLM-OCR

### 3. Очистка временных PDF
**Решение:** Ответственность на вызывающей стороне (Renderer)
**Обоснование:** Гибкость для отладки, PDF может быть использован повторно
