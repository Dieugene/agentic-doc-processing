# Review отчет: Skeleton Builder

## Общая оценка

**Статус:** Требует доработки

**Краткий вывод:** Качественная реализация основной логики с хорошим покрытием тестами. Однако выявлены отклонения от ТЗ: не реализовано заполнение `internal_structure` и отличается состав public методов от спецификации.

## Проверка соответствия ТЗ

**Технические критерии из analysis.md:**
- [x] TC-001: SkeletonBuilder реализован с методами `build_skeleton()`, `_build_node_tree()`, `_attach_tables()` - ✅ Выполнено
- [x] TC-002: `build_skeleton()` создаёт DocumentSkeleton с root node - ✅ Выполнено
- [x] TC-003: Все заголовки из structure.headers становятся Node - ✅ Выполнено
- [x] TC-004: Parent-child отношения корректны для последовательной нумерации - ✅ Выполнено
- [x] TC-005: Parent-child отношения корректны при разрывах - ✅ Выполнено
- [x] TC-006: Node.id генерируется из title (fallback на slugify) - ✅ Выполнено
- [x] TC-007: PageRange вычисляется корректно - ✅ Выполнено
- [x] TC-008: Таблицы на странице раздела прикрепляются к нему - ✅ Выполнено
- [x] TC-009: Таблицы вне разделов прикрепляются к ближайшему по странице - ✅ Выполнено
- [x] TC-010: Таблицы создаются как отдельные Node с type=TABLE - ✅ Выполнено
- [ ] TC-011: table_data заполняется в формате {type, source, data} - ⚠️ Выполнено, но `internal_structure.raw` пустой
- [x] TC-012: Unit тесты покрывают все методы - ✅ Выполнено (21 тест)
- [x] TC-013: Интеграционные тесты с mock VLM-OCR проходят - ✅ Выполнено

**Acceptance Criteria из task_brief:**
- [x] AC-001: SkeletonBuilder реализован - ✅ Выполнено
- [x] AC-002: build_skeleton() создаёт DocumentSkeleton из DocumentData - ✅ Выполнено
- [x] AC-003: Иерархия заголовков → дерево Node - ✅ Выполнено
- [x] AC-004: Таблицы интегрируются в Node.table_data - ✅ Выполнено
- [x] AC-005: Unit тесты с fixture'ами - ✅ Выполнено
- [x] AC-006: Интеграционные тесты с VLM-OCR mock - ✅ Выполнено

## Проблемы

### Проблема 1: Не реализовано заполнение internal_structure

**Файл:** `02_src/processing/skeleton_builder.py:154, 193`
**Описание:** Согласно analysis.md (раздел 3.3, раздел 6 "InternalStructure для узлов"), узлы должны заполнять `internal_structure.raw` дочерними заголовками. В реализации везде передается пустой `InternalStructure(raw={})`.

**Ожидаемое поведение (из analysis.md:347-361):**
```python
internal_structure = {
    "raw": {
        header["title"]: {
            "level": header["level"],
            "page": header["page"]
        }
        for header in all_headers
        if header["level"] >= current_node.level + 1  # Только дети
    }
}
```

**Фактическое поведение:** `internal_structure=InternalStructure(raw={})` - пустой словарь.

**Серьезность:** Средняя

**Влияние:** Нарушение TC-011 (частично), функционал из ТЗ не реализован.

---

### Проблема 2: Отсутствует метод _build_node_tree с сигнатурой из ТЗ

**Файл:** `02_src/processing/skeleton_builder.py:115-120`
**Описание:** В analysis.md указана сигнатура `_build_node_tree(self, structure: Dict[str, Any], full_text: str, document_id: str) -> Dict[str, Node]`, но в реализации метод имеет сигнатуру `_build_node_tree(self, structure, full_text, document_id)` без аннотаций типов в сигнатуре (хотя типы есть в docstring).

**Несоответствие:**
- В ТЗ (analysis.md:62): ожидается публичный метод в интерфейсе класса
- В реализации: метод является private, что корректно, но отличается от спецификации

**Серьезность:** Низкая

**Влияние:** Метод работает корректно, но отличается от документации.

---

### Проблема 3: Наличие дополнительного метода _find_parent_by_level

**Файл:** `02_src/processing/skeleton_builder.py:218-235`
**Описание:** В реализации присутствует метод `_find_parent_by_level`, который не указан в analysis.md как обязательный метод интерфейса.

**Серьезность:** Низкая

**Влияние:** Положительное изменение - хорошее разложение логики на методы. Требуется обновление документации.

---

### Проблема 4: Отсутствует fixture expected_skeleton.json

**Файл:** `02_src/processing/tests/fixtures/`
**Описание:** В analysis.md (раздел 4, п. 3) указано создание fixture `expected_skeleton.json`. Файл не создан, тесты используют fixtures программно.

**Серьезность:** Низкая

**Влияние:** Тесты работают, но отсутствует эталонный JSON для ручной верификации.

## Положительные моменты

- **Высокое качество тестов:** 21 тест покрывают все сценарии из ТЗ включая edge cases
- **Хорошая архитектура:** Логика корректно разделена на методы с понятными названиями
- **Улучшения относительно ТЗ:** Метод `_find_parent_by_level` выделен отдельно, что повышает читаемость
- **Правильная обработка edge cases:** Валидация page < 1, level < 1, empty headers
- **Полное покрытие AC:** Все 6 acceptance criteria выполнены
- **Детальное логирование:** DEBUG логи для отладки алгоритма построения

## Решение

**Действие:** Вернуть Analyst

**Обоснование:**
1. **Проблема 1** (internal_structure) - это нарушение технических критериев (TC-011). Функционал явно описан в ТЗ (analysis.md:347-361) и требует реализации.
2. **Проблемы 2-4** - требуют уточнения в technical plan: либо обновить ТЗ под текущую реализацию, либо доработать код под спецификацию.

Требуется обновление technical plan с учетом:
- Уточнения по заполнению `internal_structure.raw`
- Актуализации списка public методов класса
- Наличия/отсутствия fixture expected_skeleton.json
